<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>paarti.utils.maos_utils &#8212; paarti v0.1</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-astropy.css?v=9d21690f" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    
    <script src="../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../../_static/documentation_options.js?v=2709fde1"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="icon" href="../../../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">paarti</span><span id="logotext2"></span><span id="logotext3">:docs</span></a>
  <ul>
    
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">paarti v0.1</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for paarti.utils.maos_utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">Cutout2D</span>
<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">fitting</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">astropy</span>
<span class="kn">from</span> <span class="nn">paarti.psf_metrics</span> <span class="kn">import</span> <span class="n">metrics</span>
<span class="kn">from</span> <span class="nn">photutils</span> <span class="kn">import</span> <span class="n">CircularAperture</span><span class="p">,</span> <span class="n">CircularAnnulus</span><span class="p">,</span> <span class="n">aperture_photometry</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">scipy</span><span class="o">,</span> <span class="nn">scipy.misc</span><span class="o">,</span> <span class="nn">scipy.ndimage</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">read_csv</span>

<span class="n">strap_rmag_tab</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# File: strap_rmag.dat</span><span class="se">\n</span>
<span class="s2">MinMag  MaxMag  Integ   Gain	SFW 	Sky</span>
<span class="s2">20.0	25.0	40  	0.1 	open	1</span>
<span class="s2">19.0	20.0	40  	0.1 	open	1</span>
<span class="s2">18.0	19.0	20  	0.1 	open	1</span>
<span class="s2">17.0	18.0	10  	0.1 	open	1</span>
<span class="s2">16.0	17.0	8   	0.1 	open	1</span>
<span class="s2">15.0	16.0	4   	0.1 	open	1</span>
<span class="s2">14.0	15.0	2   	0.1 	open	1</span>
<span class="s2">13.0	14.0	1   	0.1 	open	1</span>
<span class="s2">11.0	13.0	1   	0.1 	open	0</span>
<span class="s2">10.0	11.0	1   	0.1 	open	0</span>
<span class="s2">8.5 	10.0	1   	0.1 	nd1 	0</span>
<span class="s2">6.0 	8.5 	1   	0.1 	nd2 	0</span>
<span class="s2">0.0 	6.0 	1   	0.1 	nd3 	0&quot;&quot;&quot;</span>

<div class="viewcode-block" id="keck_nea_photons">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.keck_nea_photons.html#paarti.utils.maos_utils.keck_nea_photons">[docs]</a>
<span class="k">def</span> <span class="nf">keck_nea_photons</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">wfs</span><span class="p">,</span> <span class="n">wfs_int_time</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">800.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the number of photons, number of background photons,</span>
<span class="sd">    and noise equivalent angle for a natural guide star.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    -------</span>
<span class="sd">    m : float</span>
<span class="sd">        Magnitude of guide star</span>
<span class="sd">    wfs : str</span>
<span class="sd">        Name of WFS to set camera properties.</span>

<span class="sd">    Optional Inputs:</span>
<span class="sd">    ----------------</span>
<span class="sd">    wfs_int_time : float</span>
<span class="sd">        Integration time of the WFS.</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    SNR            : float</span>
<span class="sd">        Signal-to-noise ratio of a single subaperture</span>

<span class="sd">    sigma_theta    : float</span>
<span class="sd">        Noise-equivalent angle (NEA) in milliarcseconds (mas)</span>

<span class="sd">    Np             : float</span>
<span class="sd">        Number of photons (or e-) from input guide star on subaperture</span>

<span class="sd">    Nb             : float</span>
<span class="sd">        Number of photons (or e-) from background per pixel</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    </span>
<span class="sd">    By Matthew Freeman and Paolo Turri, modified by Brooke DiGia</span>

<span class="sd">    Equations 65-68 from section 3B of Clare, R. et al (2006). </span>
<span class="sd">    Adaptive optics sky coverage modelling for extremely large </span>
<span class="sd">    telescopes. Applied Optics 45, 35 (8964-8978)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># List of pre-defined wave-front sensors (wfs)</span>
    <span class="c1"># LGSWFS-OCAM2K  : KAPA and KAPA+HODM simulation setups</span>
    <span class="c1"># LGS-HODM-HOWFS : KAPA+HODM+HOWFS</span>
    <span class="n">wfs_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LBWFS&#39;</span><span class="p">,</span> <span class="s1">&#39;LGSWFS&#39;</span><span class="p">,</span> <span class="s1">&#39;LGSWFS-OCAM2K&#39;</span><span class="p">,</span> <span class="s1">&#39;LGS-HODM-HOWFS&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;TRICK-H&#39;</span><span class="p">,</span> <span class="s1">&#39;TRICK-K&#39;</span><span class="p">,</span> <span class="s1">&#39;STRAP&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">wfs</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wfs_list</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;keck_nea_photons: Invalid WFS.&quot;</span><span class="p">)</span>
    
    <span class="c1"># Keck telescope diameter (m)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="mf">10.949</span>
    <span class="c1"># Secondary obscuration diameter (m)</span>
    <span class="n">Ds</span> <span class="o">=</span> <span class="mf">1.8</span>
    
    <span class="c1"># Initialize parameters that will be set below based on input</span>
    <span class="c1"># wave-front sensor</span>
    <span class="c1"># wavelength = 0.0  # Guide star imaging wavelength</span>
    <span class="c1"># ps = 0.0          # Pixel scale (arcsec/px)</span>
    <span class="c1"># sigma_e = 0.0     # RMS detector read noise per pixel</span>
    <span class="c1"># theta_beta = 0.0  # Spot size on detector (rad)</span>
    <span class="c1"># pix_per_ap = 0    # Pixels per subaperture, for noise calculation</span>
    
    <span class="k">if</span> <span class="n">wfs</span> <span class="o">==</span> <span class="s1">&#39;LBWFS&#39;</span><span class="p">:</span>
        <span class="n">band</span> <span class="o">=</span> <span class="s2">&quot;R&quot;</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="mf">0.641e-6</span>

        <span class="c1"># side length of square subaperture (m)</span>
        <span class="n">side</span> <span class="o">=</span> <span class="mf">0.563</span> 

        <span class="c1"># 1.5 for WFS and low bandwithth WFS from Blake&#39;s config</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="mf">1.5</span>
        
        <span class="c1"># from Carlos&#39; config</span>
        <span class="n">sigma_e</span> <span class="o">=</span> <span class="mf">7.96</span>
        
        <span class="c1"># from KAON 1303 Table 16</span>
        <span class="n">theta_beta</span> <span class="o">=</span> <span class="mf">0.49</span> <span class="o">*</span> <span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mf">60.0</span><span class="o">*</span><span class="mf">60.0</span> <span class="p">)</span>
        
        <span class="c1"># from KAON 1303 Table 8</span>
        <span class="n">throughput</span> <span class="o">=</span> <span class="mf">0.03</span>
        
        <span class="c1"># quadcell</span>
        <span class="n">pix_per_ap</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">elif</span> <span class="n">wfs</span> <span class="o">==</span> <span class="s1">&#39;LGSWFS&#39;</span><span class="p">:</span>
        <span class="n">band</span> <span class="o">=</span> <span class="s2">&quot;R&quot;</span>    <span class="c1"># not actually at V</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="mf">0.589e-6</span>
        
        <span class="c1"># side length of square subaperture (m)</span>
        <span class="n">side</span> <span class="o">=</span> <span class="mf">0.563</span>
        
        <span class="c1"># from Carlos&#39; config file</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="mf">3.0</span>
        <span class="n">sigma_e</span> <span class="o">=</span> <span class="mf">3.0</span>
        
        <span class="c1"># from KAON 1303 Table 20</span>
        <span class="n">theta_beta</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mf">60.0</span><span class="o">*</span><span class="mf">60.0</span> <span class="p">)</span>
        
        <span class="c1"># KAON 1303 Table 8 states 0.36, but Np=1000 is already</span>
        <span class="c1"># measured on the detector. Modified to account for QE=0.88 </span>
        <span class="c1"># on the WFS detector at R-band from error budget spreadsheet</span>
        <span class="n">throughput</span> <span class="o">=</span> <span class="mf">0.36</span> <span class="o">*</span> <span class="mf">0.88</span>
        
        <span class="c1"># quadcell</span>
        <span class="n">pix_per_ap</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">elif</span> <span class="n">wfs</span> <span class="o">==</span> <span class="s1">&#39;LGSWFS-OCAM2K&#39;</span><span class="p">:</span>
        <span class="n">band</span> <span class="o">=</span> <span class="s2">&quot;R&quot;</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="mf">0.589e-6</span>
        
        <span class="c1"># side length of square subaperture (m)</span>
        <span class="n">side</span> <span class="o">=</span> <span class="mf">0.563</span>
        
        <span class="c1"># from Carlos&#39; config file</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="mf">3.0</span>
        <span class="n">sigma_e</span> <span class="o">=</span> <span class="mf">0.5</span>
        
        <span class="c1"># from KAON 1303 Table 20</span>
        <span class="n">theta_beta</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mf">60.0</span><span class="o">*</span><span class="mf">60.0</span> <span class="p">)</span>
        
        <span class="c1"># KAON 1303 Table 8 states 0.36, but Np=1000 is already</span>
        <span class="c1"># measured on the detector. Modified to account for QE=0.88 </span>
        <span class="c1"># on the WFS detector at R-band from error budget spreadsheet</span>
        <span class="n">throughput</span> <span class="o">=</span> <span class="mf">0.36</span> <span class="o">*</span> <span class="mf">0.88</span>
        
        <span class="c1"># quadcell</span>
        <span class="n">pix_per_ap</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">elif</span> <span class="n">wfs</span> <span class="o">==</span> <span class="s1">&#39;LGS-HODM-HOWFS&#39;</span><span class="p">:</span>
        <span class="n">band</span> <span class="o">=</span> <span class="s2">&quot;R&quot;</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="mf">0.589e-6</span>
        <span class="n">side</span> <span class="o">=</span> <span class="mf">0.17</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="mf">3.0</span>
        <span class="n">sigma_e</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="n">theta_beta</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mf">60.0</span><span class="o">*</span><span class="mf">60.0</span> <span class="p">)</span>
        <span class="n">throughput</span> <span class="o">=</span> <span class="mf">0.36</span> <span class="o">*</span> <span class="mf">0.88</span>
        <span class="n">pix_per_ap</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">elif</span> <span class="n">wfs</span> <span class="o">==</span> <span class="s1">&#39;TRICK-H&#39;</span><span class="p">:</span>
        <span class="n">band</span> <span class="o">=</span> <span class="s2">&quot;H&quot;</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="mf">1.63e-6</span>

        <span class="c1"># side length of square subaperture (m)</span>
        <span class="c1"># turn into square aperture of same area as primary</span>
        <span class="n">side</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">D</span>  <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">Ds</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>

        <span class="c1"># From Carlos&#39; config file</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="mf">0.06</span>
        <span class="c1"># Modified to get SNR=5 at H=15</span>
        <span class="n">sigma_e</span> <span class="o">=</span> <span class="mf">11.188</span>

        <span class="c1"># Using OSIRIS FWHM from KAON 1303 Table 13 (as suggested by Peter)</span>
        <span class="n">theta_beta</span> <span class="o">=</span> <span class="mf">0.055</span> <span class="o">*</span> <span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mf">60.0</span><span class="o">*</span><span class="mf">60.0</span> <span class="p">)</span>

        <span class="c1"># from KAON 1303 Table 8</span>
        <span class="n">throughput</span> <span class="o">=</span> <span class="mf">0.56</span>
        <span class="c1"># Modify to add 4 lenses and a filter inside TRICK</span>
        <span class="c1"># TODO: Need to put in detector QE</span>
        <span class="n">throughput</span> <span class="o">*=</span> <span class="mf">0.96</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="mf">0.95</span>
        
        <span class="c1"># ROI reduces from 16x16 to 2x2 as residual is reduced</span>
        <span class="n">pix_per_ap</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">elif</span> <span class="n">wfs</span> <span class="o">==</span> <span class="s1">&#39;TRICK-K&#39;</span><span class="p">:</span>
        <span class="n">band</span> <span class="o">=</span> <span class="s2">&quot;K&quot;</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="mf">2.19e-6</span>

        <span class="c1"># side length of square subaperture (m) </span>
        <span class="n">side</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">D</span>  <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">Ds</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
        
        <span class="c1"># From Carlos&#39; config file</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="mf">0.04</span>
        <span class="c1"># Modified to get SNR=5 at H=15</span>
        <span class="n">sigma_e</span> <span class="o">=</span> <span class="mf">11.188</span>
        
        <span class="c1"># Scaling the K band 0.055 by 2.19/1.63 (wavelength ratio)        </span>
        <span class="n">theta_beta</span> <span class="o">=</span> <span class="mf">0.074</span> <span class="o">*</span> <span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mf">60.0</span><span class="o">*</span><span class="mf">60.0</span> <span class="p">)</span>

        <span class="c1"># from KAON 1303 Table 8</span>
        <span class="n">throughput</span> <span class="o">=</span> <span class="mf">0.62</span>
        <span class="c1"># Modify to add 4 lenses and a filter inside TRICK</span>
        <span class="c1"># TODO: Need to put in detector QE</span>
        <span class="n">throughput</span> <span class="o">*=</span> <span class="mf">0.96</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="mf">0.95</span>

        <span class="c1"># ROI decreases from 16x16 to 2x2 as residual reduces</span>
        <span class="n">pix_per_ap</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">elif</span> <span class="n">wfs</span> <span class="o">==</span> <span class="s1">&#39;STRAP&#39;</span><span class="p">:</span>
        <span class="n">band</span> <span class="o">=</span> <span class="s2">&quot;R&quot;</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="mf">0.641e-6</span>

        <span class="c1"># side length of square subaperture (m)          </span>
        <span class="n">side</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">D</span>  <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">Ds</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
        
        <span class="c1"># From KAON 1322, just above equation 19</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="mf">1.3</span>
        <span class="c1"># Made up...everything seems limited by photon/background noise</span>
        <span class="n">sigma_e</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="c1"># There appears to be inconsistencies in that KAON 1322 Section 7.6</span>
        <span class="c1"># which quotes 3000 photons/aperture/frame (not sure what </span>
        <span class="c1"># brightness star this would be for). Maybe GC R=15?</span>
        
        <span class="c1"># from KAON 1303 Table 16</span>
        <span class="n">theta_beta</span> <span class="o">=</span> <span class="mf">0.49</span> <span class="o">*</span> <span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mf">60.0</span><span class="o">*</span><span class="mf">60.0</span> <span class="p">)</span>

        <span class="c1"># from KAON 1303 Table 7</span>
        <span class="c1"># Modified to account for QE=0.50 on the WFS detector at R-band</span>
        <span class="c1"># from error budget spreadsheet</span>
        <span class="n">throughput</span> <span class="o">=</span> <span class="mf">0.32</span> <span class="c1">#* 0.50</span>

        <span class="c1"># ROI</span>
        <span class="n">pix_per_ap</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="n">SNR</span><span class="p">,</span> <span class="n">sigma_theta</span><span class="p">,</span> <span class="n">Np</span><span class="p">,</span> <span class="n">Nb</span> <span class="o">=</span> <span class="n">keck_nea_photons_any_config</span><span class="p">(</span><span class="n">wfs</span><span class="p">,</span>
                                                           <span class="n">side</span><span class="p">,</span>
                                                           <span class="n">throughput</span><span class="p">,</span>
                                                           <span class="n">ps</span><span class="p">,</span>
                                                           <span class="n">theta_beta</span><span class="p">,</span>
                                                           <span class="n">band</span><span class="p">,</span>
                                                           <span class="n">sigma_e</span><span class="p">,</span>
                                                           <span class="n">pix_per_ap</span><span class="p">,</span>
                                                           <span class="n">wfs_int_time</span><span class="p">,</span>
                                                           <span class="n">m</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SNR</span><span class="p">,</span> <span class="n">sigma_theta</span><span class="p">,</span> <span class="n">Np</span><span class="p">,</span> <span class="n">Nb</span></div>


<div class="viewcode-block" id="keck_nea_photons_any_config">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.keck_nea_photons_any_config.html#paarti.utils.maos_utils.keck_nea_photons_any_config">[docs]</a>
<span class="k">def</span> <span class="nf">keck_nea_photons_any_config</span><span class="p">(</span><span class="n">wfs</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">throughput</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="n">theta_beta</span><span class="p">,</span>
                                <span class="n">band</span><span class="p">,</span> <span class="n">sigma_e</span><span class="p">,</span> <span class="n">pix_per_ap</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inputs:</span>
<span class="sd">    ----------</span>
<span class="sd">    wfs         : str</span>
<span class="sd">        Arbitrary string name of WFS for printouts. Note there is one</span>
<span class="sd">        override if &quot;LGSWFS&quot; is in your wfs name, then it resets the</span>
<span class="sd">        number of background photons to 6 rather than taking the sky</span>
<span class="sd">        background. This is presumably from some Rayleigh backscatter</span>
<span class="sd">        of the laser spot.  This probably needs to be fixed.</span>

<span class="sd">    side        : float</span>
<span class="sd">        Side of a sub-aperture in meters</span>

<span class="sd">    throughput  : float</span>
<span class="sd">        Fractional throughput (0-1) of whole telescope + WFS system</span>

<span class="sd">    ps          : float</span>
<span class="sd">        Plate scale in arcsec / pixel on the WFS</span>

<span class="sd">    theta_beta  : float</span>
<span class="sd">        Spot size on sub-aperture in units of radians. For LGS spots, use</span>
<span class="sd">        (1.5&#39;&#39; * pi /180) / (60*60)</span>

<span class="sd">    band        : str</span>
<span class="sd">        Filter used for WFSing. This is used to determine the sky background</span>
<span class="sd">        flux contributing to each sub-aperture </span>

<span class="sd">    sigma_e     : float</span>
<span class="sd">        Readnoise in electrons</span>

<span class="sd">    pix_per_ap  : int</span>
<span class="sd">        Number of pixels per sub-aperture</span>

<span class="sd">    time        : float</span>
<span class="sd">        Integration time of the WFS in unit of seconds</span>

<span class="sd">    m           : float</span>
<span class="sd">        Magnitude of the guide star in the specified filter</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ----------</span>
<span class="sd">    SNR         : float</span>
<span class="sd">        Signal-to-noise ratio</span>

<span class="sd">    sigma_theta : float</span>
<span class="sd">        Noise-equivalent angle in milliarcsec</span>
<span class="sd"> </span>
<span class="sd">    Np          : float</span>
<span class="sd">        Number of photons from the star per pixel within</span>
<span class="sd">        subaperture</span>

<span class="sd">    Nb          : float</span>
<span class="sd">        Number of background photons per pixel within</span>
<span class="sd">        subaperture</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Assumptions:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Wave-Front Sensor       = </span><span class="si">{</span><span class="n">wfs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Pupil Aperture Diameter = </span><span class="si">{</span><span class="n">side</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> m (assumed square)&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Throughput (w QE)       = </span><span class="si">{</span><span class="n">throughput</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Plate Scale             = </span><span class="si">{</span><span class="n">ps</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> arcsec/pix&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Spot Size Diameter      = </span><span class="si">{</span><span class="n">theta_beta</span><span class="o">*</span><span class="mi">206265</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> arcsec&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Filter                  = </span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Readnoise               = </span><span class="si">{</span><span class="n">sigma_e</span><span class="si">}</span><span class="s1"> e-&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Pixels per Subaperture  = </span><span class="si">{</span><span class="n">pix_per_ap</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Integration Time        = </span><span class="si">{</span><span class="n">time</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> s&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Guide Star Magnitude    = </span><span class="si">{</span><span class="n">m</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    
    <span class="c1"># Calculate number of photons and background photons</span>
    <span class="n">Np</span><span class="p">,</span> <span class="n">Nb</span> <span class="o">=</span> <span class="n">n_photons</span><span class="p">(</span><span class="n">side</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="n">throughput</span><span class="p">)</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    # Fix LGS background</span>
<span class="sd">    if &#39;LGSWFS&#39; in wfs:</span>
<span class="sd">        # Convert 6 background photons per subaperture to</span>
<span class="sd">        # background per pixel (4 pixels per subaperture,</span>
<span class="sd">        # quadcell)</span>
<span class="sd">        Nb = 6.0 * (1.0/4.0)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># # area of supaperture        </span>
    <span class="c1"># A_sa = side**2</span>
    <span class="c1"># # total number of subapertures for the NGS WFS</span>
    <span class="c1"># N_sa = A_sa/(math.pi*(D/2)**2)</span>
    <span class="c1"># # Effective spot size of the subaperture NGS assuming</span>
    <span class="c1"># # seeing limited image. (eq 67).</span>
    <span class="c1"># theta_beta = wavelength/(4*r_0*0.4258)</span>
    <span class="c1"># # Effective spot size of the subaperture NGS assuming a</span>
    <span class="c1"># # diffraction limited core. (eq 68)    </span>
    <span class="c1"># theta_beta = 3*math.pi*wavelength*np.sqrt(N_sa)/(16*D)</span>
    <span class="c1"># signal to noise ratio of a single subaperture (eq 66)</span>
    
    <span class="n">SNR</span> <span class="o">=</span> <span class="n">Np</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Np</span> <span class="o">+</span> <span class="n">pix_per_ap</span><span class="o">*</span><span class="n">Nb</span> <span class="o">+</span> <span class="n">pix_per_ap</span><span class="o">*</span><span class="n">sigma_e</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Noise equivalent angle in milliarcseconds (eq 65)</span>
    <span class="n">sigma_theta</span> <span class="o">=</span> <span class="n">theta_beta</span><span class="o">/</span><span class="n">SNR</span>  <span class="o">*</span> <span class="p">(</span> <span class="mf">180.0</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="mf">1000.0</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Outputs:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  N_photons from star (powfs.siglev for MAOS config): </span><span class="si">{</span><span class="n">Np</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  N_photons per pixel from background (powfs.bkgrnd):   </span><span class="si">{</span><span class="n">Nb</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  SNR:                                   </span><span class="si">{</span><span class="n">SNR</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  NEA (powfs.nearecon): </span><span class="si">{</span><span class="n">sigma_theta</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> mas&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">SNR</span><span class="p">,</span> <span class="n">sigma_theta</span><span class="p">,</span> <span class="n">Np</span><span class="p">,</span> <span class="n">Nb</span></div>

    
<div class="viewcode-block" id="n_photons">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.n_photons.html#paarti.utils.maos_utils.n_photons">[docs]</a>
<span class="k">def</span> <span class="nf">n_photons</span><span class="p">(</span><span class="n">side</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="n">throughput</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the number of photons from a star and</span>
<span class="sd">    background incident on a square area in a given time </span>
<span class="sd">    interval.</span>

<span class="sd">    By Paolo Turri</span>
<span class="sd">        </span>
<span class="sd">    Bibliography:</span>
<span class="sd">    [1] Bessel et al. (1998)</span>
<span class="sd">    [2] Mann &amp; von Braun (2015)</span>
<span class="sd">    [3] https://www.cfht.hawaii.edu/Instruments/ObservatoryManual/CFHT_ObservatoryManual_%28Sec_2%29.html</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    side       : float</span>
<span class="sd">        Side of square aperture (m)</span>

<span class="sd">    time       : float</span>
<span class="sd">        Time interval (s)</span>

<span class="sd">    m          : float</span>
<span class="sd">        Apparent magnitude (Vega system)</span>

<span class="sd">    band       : string</span>
<span class="sd">        Band name (&quot;U&quot;, &quot;B&quot;, &quot;V&quot;, &quot;R&quot;, &quot;I&quot;, &quot;J&quot;, &quot;H&quot;, &quot;K&quot;)</span>
<span class="sd">        </span>
<span class="sd">    ps         : float</span>
<span class="sd">        Pixel scale (arcsec/px)</span>

<span class="sd">    throughput : float</span>
<span class="sd">        Throughput with quantum efficiency</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    n_ph_star  : float</span>
<span class="sd">        Number of star photons</span>

<span class="sd">    n_ph_bkg   : float</span>
<span class="sd">        Number of background photons (px^-1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Fixed parameters</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">2.99792458e8</span>   <span class="c1"># Speed of light (m s^-1)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mf">6.6260755e-27</span>  <span class="c1"># Plank constant (erg s)</span>
    <span class="c1"># Bands&#39; names, effective wavelengths (microns), equivalent widths</span>
    <span class="c1"># (microns), fluxes (10^-11 erg s^-1 cm^-2 A^-1) and background</span>
    <span class="c1"># in (magnitudes arcsec^-2) [1, 2, 3].</span>
    <span class="n">bands</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;J&quot;</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">],</span>
             <span class="s1">&#39;lambd&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.366</span><span class="p">,</span> <span class="mf">0.438</span><span class="p">,</span> <span class="mf">0.545</span><span class="p">,</span> <span class="mf">0.641</span><span class="p">,</span> <span class="mf">0.798</span><span class="p">,</span> <span class="mf">1.22</span><span class="p">,</span> <span class="mf">1.63</span><span class="p">,</span> <span class="mf">2.19</span><span class="p">],</span>
             <span class="s1">&#39;delta_lambd&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0665</span><span class="p">,</span> <span class="mf">0.1037</span><span class="p">,</span> <span class="mf">0.0909</span><span class="p">,</span> <span class="mf">0.1479</span><span class="p">,</span> <span class="mf">0.1042</span><span class="p">,</span> <span class="mf">0.3268</span><span class="p">,</span> <span class="mf">0.2607</span><span class="p">,</span>
                             <span class="mf">0.5569</span><span class="p">],</span>
             <span class="s1">&#39;phi_erg&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">417.5</span><span class="p">,</span> <span class="mi">632</span><span class="p">,</span> <span class="mf">363.1</span><span class="p">,</span> <span class="mf">217.7</span><span class="p">,</span> <span class="mf">112.6</span><span class="p">,</span> <span class="mf">31.47</span><span class="p">,</span> <span class="mf">11.38</span><span class="p">,</span> <span class="mf">3.961</span><span class="p">],</span>
             <span class="s1">&#39;bkg_m&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">21.6</span><span class="p">,</span> <span class="mf">22.3</span><span class="p">,</span> <span class="mf">21.1</span><span class="p">,</span> <span class="mf">20.3</span><span class="p">,</span> <span class="mf">19.2</span><span class="p">,</span> <span class="mf">14.8</span><span class="p">,</span> <span class="mf">13.4</span><span class="p">,</span> <span class="mf">12.6</span><span class="p">]}</span>

    <span class="c1"># Get band&#39;s data</span>
    <span class="n">band_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bands</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">band</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Band effective wavelength (microns)    </span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bands</span><span class="p">[</span><span class="s1">&#39;lambd&#39;</span><span class="p">][</span><span class="n">band_idx</span><span class="p">])</span>
    <span class="c1"># Band equivalent width (microns)</span>
    <span class="n">delta_lamb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bands</span><span class="p">[</span><span class="s1">&#39;delta_lambd&#39;</span><span class="p">][</span><span class="n">band_idx</span><span class="p">])</span>
    <span class="c1"># Flux (erg s^-1 cm^-2 A^-1)</span>
    <span class="n">phi_erg</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bands</span><span class="p">[</span><span class="s1">&#39;phi_erg&#39;</span><span class="p">][</span><span class="n">band_idx</span><span class="p">])</span>
    <span class="c1"># Background magnitude (arcsec^-2)    </span>
    <span class="n">bkg_m</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bands</span><span class="p">[</span><span class="s1">&#39;bkg_m&#39;</span><span class="p">][</span><span class="n">band_idx</span><span class="p">])</span>

    <span class="c1"># Band frequency (Hz)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">lambd</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>
    <span class="c1"># Numeric flux (s^-1 cm^-2 A^-1)</span>
    <span class="n">phi_n</span> <span class="o">=</span> <span class="n">phi_erg</span> <span class="o">*</span> <span class="mf">1e-11</span> <span class="o">/</span> <span class="p">(</span> <span class="n">h</span> <span class="o">*</span> <span class="n">f</span> <span class="p">)</span>
    <span class="c1"># Zeropoint (m = 0) number of photons on detector</span>
    <span class="n">n_ph_0</span> <span class="o">=</span> <span class="n">phi_n</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">side</span> <span class="o">*</span> <span class="mf">1e2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">time</span> <span class="o">*</span> <span class="n">delta_lamb</span> <span class="o">*</span> <span class="mf">1e4</span> <span class="o">*</span> <span class="n">throughput</span>  
    <span class="c1"># Number of star photons</span>
    <span class="n">n_ph_star</span> <span class="o">=</span> <span class="n">n_ph_0</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.4</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="p">)</span> 

    <span class="c1"># Number of background photons (px^-1)</span>
    <span class="n">n_ph_bkg</span> <span class="o">=</span> <span class="n">n_ph_0</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.4</span> <span class="o">*</span> <span class="n">bkg_m</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ps</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  
    
    <span class="k">return</span> <span class="n">n_ph_star</span><span class="p">,</span> <span class="n">n_ph_bkg</span></div>


<div class="viewcode-block" id="keck_ttmag_to_itime">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.keck_ttmag_to_itime.html#paarti.utils.maos_utils.keck_ttmag_to_itime">[docs]</a>
<span class="k">def</span> <span class="nf">keck_ttmag_to_itime</span><span class="p">(</span><span class="n">ttmag</span><span class="p">,</span> <span class="n">wfs</span><span class="o">=</span><span class="s1">&#39;strap&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the expected integration time for STRAP given</span>
<span class="sd">    a tip-tilt star magnitude in the R-band.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    ttmag : float</span>
<span class="sd">        Tip-tilt star brightness in apparent R-band magnitudes in</span>
<span class="sd">        the Vega system</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    itime : float</span>
<span class="sd">        The integration time used for STRAP in seconds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">wfs</span> <span class="o">==</span> <span class="s1">&#39;strap&#39;</span><span class="p">:</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">strap_rmag_tab</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid WFS type: </span><span class="si">{</span><span class="n">wfs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Find the bin where our TT star belongs.</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">tab</span><span class="p">[</span><span class="s1">&#39;MinMag&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ttmag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ttmag</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="p">[</span><span class="s1">&#39;MaxMag&#39;</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Fetch the integration time. </span>
    <span class="n">itime</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span><span class="s1">&#39;Integ&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    
    <span class="k">return</span> <span class="n">itime</span></div>


<div class="viewcode-block" id="print_wfe_metrics">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.print_wfe_metrics.html#paarti.utils.maos_utils.print_wfe_metrics">[docs]</a>
<span class="k">def</span> <span class="nf">print_wfe_metrics</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to print various wave-front error (WFE) metrics </span>
<span class="sd">    to terminal.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    directory      : string, default is current directory</span>
<span class="sd">        Path to directory where simulation results live</span>

<span class="sd">    seed           : int, default=10</span>
<span class="sd">        Seed with which simulation was run</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    open_mean_nm   : array, len=3, dtype=float</span>
<span class="sd">        Array containing WFE metrics for open-loop MAOS results</span>

<span class="sd">    closed_mean_nm : array, len=3, dtype=float</span>
<span class="sd">        Array containing WFE metrics for closed-loop MAOS results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Import the MAOS readbin function</span>
    <span class="kn">import</span> <span class="nn">readbin</span>
    
    <span class="n">results_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">Res_</span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s1">.bin&#39;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">readbin</span><span class="o">.</span><span class="n">readbin</span><span class="p">(</span><span class="n">results_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Looking in directory:&quot;</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>

    <span class="c1"># Open-loop WFE (nm): Piston removed, TT only, Piston+TT removed</span>
    <span class="n">open_mean_nm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1.0e9</span>

    <span class="c1"># Closed-loop WFE (nm): Piston removed, TT only, Piston+TT removed</span>
    <span class="n">clos_mean_nm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1.0e9</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WaveFront Error (nm): [note, piston removed from all]&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;      &quot;</span><span class="si">:</span><span class="s1">&lt;7s</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="s2">&quot;Total&quot;</span><span class="si">:</span><span class="s1">&gt;11s</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="s2">&quot;High_Order&quot;</span><span class="si">:</span><span class="s1">&gt;11s</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="s2">&quot;TT&quot;</span><span class="si">:</span><span class="s1">&gt;11s</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;Open  &quot;</span><span class="si">:</span><span class="s1">&lt;7s</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">open_mean_nm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">11.1f</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">open_mean_nm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s1">11.1f</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">open_mean_nm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">11.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;Closed&quot;</span><span class="si">:</span><span class="s1">&lt;7s</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">clos_mean_nm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">11.1f</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">clos_mean_nm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s1">11.1f</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">clos_mean_nm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">11.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">open_mean_nm</span><span class="p">,</span> <span class="n">clos_mean_nm</span></div>

    
<div class="viewcode-block" id="print_psf_metrics_x0y0">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.print_psf_metrics_x0y0.html#paarti.utils.maos_utils.print_psf_metrics_x0y0">[docs]</a>
<span class="k">def</span> <span class="nf">print_psf_metrics_x0y0</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">oversamp</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print some PSF metrics for a central PSF computed by MAOS</span>
<span class="sd">    at an arbitrary number of wavelengths. Closed-loop.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    directory        : string, default is current directory</span>
<span class="sd">        Directory where MAOS simulation results live</span>

<span class="sd">    oversamp         : int, default=3</span>

<span class="sd">    seed             : int, default=10</span>
<span class="sd">        Simulation seed (seed value for which MAOS simulation was run)</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    wavelengths      : array, dtype=float</span>
<span class="sd">        Array of wavelengths for which MAOS simulation was run and for</span>
<span class="sd">        which output metrics were calculated</span>

<span class="sd">    strehl_values    : array, dtype=float</span>
<span class="sd">        Array of Strehl values for each wavelength</span>

<span class="sd">    fwhm_gaus_values : array, dtype=float</span>
<span class="sd">        Array of FWHM values for Gaussians fit to each MAOS PSF at</span>
<span class="sd">        each wavelength</span>

<span class="sd">    fwhm_emp_values  : array, dtype=float</span>
<span class="sd">        Array of empirical FWHM values for each MAOS PSF. Empirical</span>
<span class="sd">        FWHM is calculated by locating the pixel with the largest flux,</span>
<span class="sd">        dividing that flux by 2, finding the nearest pixel with this halved </span>
<span class="sd">        flux value, and computing the distance between them. This quantity</span>
<span class="sd">        is then converted to micro-arcsec (mas) using the MAOS pixel scale</span>
<span class="sd">        (arcsec/px) from the MAOS PSF header</span>

<span class="sd">    r_ee80_values    : array, dtype=float</span>
<span class="sd">        Array of radii for each MAOS PSF. At each wavelength, a radius</span>
<span class="sd">        is computed on the MAOS PSF, within which 80% of the total</span>
<span class="sd">        image flux is contained.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Looking in </span><span class="si">%s</span><span class="s2"> for simulation results...&quot;</span> <span class="o">%</span> <span class="n">directory</span><span class="p">)</span>  
    <span class="n">fits_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;evlpsfcl_</span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s1">_x0_y0.fits&#39;</span><span class="p">)</span>
    <span class="n">psf_all_wvls</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fits_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">nwvl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">psf_all_wvls</span><span class="p">)</span>

    <span class="n">wavelengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nwvl</span><span class="p">)</span>
    <span class="n">strehl_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nwvl</span><span class="p">)</span>
    <span class="n">fwhm_gaus_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nwvl</span><span class="p">)</span>
    <span class="n">fwhm_emp_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nwvl</span><span class="p">)</span>
    <span class="n">r_ee80_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nwvl</span><span class="p">)</span>
 
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;Wavelength&quot;</span><span class="si">:</span><span class="s1">10s</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;Strehl&quot;</span><span class="si">:</span><span class="s1">&gt;6s</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;FWHM_gaus&quot;</span><span class="si">:</span><span class="s1">&gt;10s</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;FWHM_emp&quot;</span><span class="si">:</span><span class="s1">&gt;10s</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;r_EE80&quot;</span><span class="si">:</span><span class="s1">&gt;6s</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;(microns)&quot;</span><span class="si">:</span><span class="s1">10s</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;&quot;</span><span class="si">:</span><span class="s1">&gt;6s</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;(mas)&quot;</span><span class="si">:</span><span class="s1">&gt;10s</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;(mas)&quot;</span><span class="si">:</span><span class="s1">&gt;10s</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;(mas)&quot;</span><span class="si">:</span><span class="s1">&gt;6s</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwvl</span><span class="p">):</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="n">psf_all_wvls</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">psf_all_wvls</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="n">mets</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">calc_psf_metrics_single</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;DP&#39;</span><span class="p">],</span> 
                                               <span class="n">oversamp</span><span class="o">=</span><span class="n">oversamp</span><span class="p">)</span>
        <span class="n">wavelengths</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;WVL&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.0e6</span>
        <span class="n">strehl_values</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="o">=</span> <span class="n">mets</span><span class="p">[</span><span class="s2">&quot;strehl&quot;</span><span class="p">]</span>
        <span class="n">fwhm_gaus_values</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="o">=</span> <span class="n">mets</span><span class="p">[</span><span class="s2">&quot;emp_fwhm&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.0e3</span>
        <span class="n">fwhm_emp_values</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="o">=</span> <span class="n">mets</span><span class="p">[</span><span class="s2">&quot;fwhm&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.0e3</span>
        <span class="n">r_ee80_values</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="o">=</span> <span class="n">mets</span><span class="p">[</span><span class="s2">&quot;ee80&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.0e3</span>

        <span class="n">sout</span>  <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;WVL&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e6</span><span class="si">:</span><span class="s1">10.3f</span><span class="si">}</span><span class="s1"> &#39;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mets</span><span class="p">[</span><span class="s2">&quot;strehl&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">6.2f</span><span class="si">}</span><span class="s1"> &#39;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mets</span><span class="p">[</span><span class="s2">&quot;emp_fwhm&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e3</span><span class="si">:</span><span class="s1">10.1f</span><span class="si">}</span><span class="s1"> &#39;</span> 
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mets</span><span class="p">[</span><span class="s2">&quot;fwhm&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e3</span><span class="si">:</span><span class="s1">10.1f</span><span class="si">}</span><span class="s1"> &#39;</span> 
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mets</span><span class="p">[</span><span class="s2">&quot;ee80&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e3</span><span class="si">:</span><span class="s1">6.1f</span><span class="si">}</span><span class="s1">&#39;</span> 
        <span class="nb">print</span><span class="p">(</span><span class="n">sout</span><span class="p">)</span>

    <span class="n">psf_all_wvls</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">wavelengths</span><span class="p">,</span> <span class="n">strehl_values</span><span class="p">,</span> <span class="n">fwhm_gaus_values</span><span class="p">,</span> <span class="n">fwhm_emp_values</span><span class="p">,</span> <span class="n">r_ee80_values</span></div>


<div class="viewcode-block" id="print_psf_metrics_open">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.print_psf_metrics_open.html#paarti.utils.maos_utils.print_psf_metrics_open">[docs]</a>
<span class="k">def</span> <span class="nf">print_psf_metrics_open</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">oversamp</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print some PSF metrics for a central PSF computed by MAOS</span>
<span class="sd">    at an arbitrary number of wavelengths. Open-loop.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    directory : string, default is current directory</span>
<span class="sd">        Directory where MAOS simulation results live</span>

<span class="sd">    oversamp  : int, default=3</span>

<span class="sd">    seed      : int, default=10</span>
<span class="sd">        Seed corresponding to MAOS simulation (same value that</span>
<span class="sd">        was given to MAOS to run the simulation)</span>
<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    None, prints to terminal</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fits_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;evlpsfol_</span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">)</span>
    <span class="n">psf_all_wvls</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fits_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">nwvl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">psf_all_wvls</span><span class="p">)</span>
 
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;Wavelength&quot;</span><span class="si">:</span><span class="s1">10s</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;Strehl&quot;</span><span class="si">:</span><span class="s1">&gt;6s</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;FWHM_gaus&quot;</span><span class="si">:</span><span class="s1">&gt;10s</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;FWHM_emp&quot;</span><span class="si">:</span><span class="s1">&gt;10s</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;r_EE80&quot;</span><span class="si">:</span><span class="s1">&gt;6s</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;(microns)&quot;</span><span class="si">:</span><span class="s1">10s</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;&quot;</span><span class="si">:</span><span class="s1">&gt;6s</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;(mas)&quot;</span><span class="si">:</span><span class="s1">&gt;10s</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;(mas)&quot;</span><span class="si">:</span><span class="s1">&gt;10s</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;(mas)&quot;</span><span class="si">:</span><span class="s1">&gt;6s</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwvl</span><span class="p">):</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="n">psf_all_wvls</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">psf_all_wvls</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="n">mets</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">calc_psf_metrics_single</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;DP&#39;</span><span class="p">],</span>
                                               <span class="n">oversamp</span><span class="o">=</span><span class="n">oversamp</span><span class="p">)</span>
        <span class="n">sout</span>  <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;WVL&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e6</span><span class="si">:</span><span class="s1">10.3f</span><span class="si">}</span><span class="s1"> &#39;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mets</span><span class="p">[</span><span class="s2">&quot;strehl&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">6.2f</span><span class="si">}</span><span class="s1"> &#39;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mets</span><span class="p">[</span><span class="s2">&quot;emp_fwhm&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e3</span><span class="si">:</span><span class="s1">10.1f</span><span class="si">}</span><span class="s1"> &#39;</span> 
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mets</span><span class="p">[</span><span class="s2">&quot;fwhm&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e3</span><span class="si">:</span><span class="s1">10.1f</span><span class="si">}</span><span class="s1"> &#39;</span> 
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mets</span><span class="p">[</span><span class="s2">&quot;ee80&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e3</span><span class="si">:</span><span class="s1">6.1f</span><span class="si">}</span><span class="s1">&#39;</span> 
        <span class="nb">print</span><span class="p">(</span><span class="n">sout</span><span class="p">)</span>

    <span class="n">psf_all_wvls</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="read_maos_psd">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.read_maos_psd.html#paarti.utils.maos_utils.read_maos_psd">[docs]</a>
<span class="k">def</span> <span class="nf">read_maos_psd</span><span class="p">(</span><span class="n">psd_input_file</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;jitter&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read in a MAOS PSD file and return the frequency and PSD arrays</span>
<span class="sd">    with units. Note, there are two types...a &quot;jitter&quot; file usually</span>
<span class="sd">    has input for windshake and vibrations, which is in units of</span>
<span class="sd">    radian^2/Hz. The second is a the residual WFE PSD output by</span>
<span class="sd">    MAOS in units of m^2/Hz.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    psd_input_file : string</span>
<span class="sd">        Path to input PSD file</span>

<span class="sd">    type           : string, default=&#39;jitter&#39;</span>
<span class="sd">        Type of input PSD file</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    freq           : array, dtype=float</span>
<span class="sd">        Frequency array with units attached</span>

<span class="sd">    psd            : array, dtype=float</span>
<span class="sd">        PSD array with units attached</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">readbin</span>
    
    <span class="k">if</span> <span class="n">psd_input_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;fits&#39;</span><span class="p">):</span>
        <span class="n">psd_in</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">psd_input_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">psd_in</span> <span class="o">=</span> <span class="n">readbin</span><span class="o">.</span><span class="n">readbin</span><span class="p">(</span><span class="n">psd_input_file</span><span class="p">)</span>

    <span class="n">freq</span> <span class="o">=</span> <span class="n">psd_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Hz</span>

    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;jitter&#39;</span><span class="p">:</span>
        <span class="n">psd</span> <span class="o">=</span> <span class="n">psd_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">radian</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">Hz</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">psd</span> <span class="o">=</span> <span class="n">psd_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">Hz</span>

    <span class="k">return</span> <span class="n">freq</span><span class="p">,</span> <span class="n">psd</span></div>

    
<div class="viewcode-block" id="psd_add_vibrations">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.psd_add_vibrations.html#paarti.utils.maos_utils.psd_add_vibrations">[docs]</a>
<span class="k">def</span> <span class="nf">psd_add_vibrations</span><span class="p">(</span><span class="n">psd_input_file</span><span class="p">,</span> <span class="n">vib_freq</span><span class="p">,</span> <span class="n">vib_jitter_amp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take an input temporal power-spectral density (PSD) function in rad^2/Hz</span>
<span class="sd">    (as expected for MAOS) and modify it to add a vibration peak with</span>
<span class="sd">    a log-normal distribution peaked at the input vibration frequency</span>
<span class="sd">    and with an integrated jitter amplitude equal to the specified value</span>
<span class="sd">    in arcseconds.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    psd_input_file : string</span>
<span class="sd">        The name of the input PSD file for windshake and vibrations in </span>
<span class="sd">        MAOS format. This is a 2 column binary array with the first column</span>
<span class="sd">        containing frequency in Hz and the second column containing the</span>
<span class="sd">        PSD in radian^2 / Hz. The file should be readable by the MAOS</span>
<span class="sd">        readbin utility or it should be a FITS file</span>

<span class="sd">    vib_freq       : float</span>
<span class="sd">        Peak vibration frequency in Hz</span>

<span class="sd">    vib_jitter_amp : float</span>
<span class="sd">        Integrated jitter in arcsec over the whole vibration peak</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    freq           : array, dtype=float</span>
<span class="sd">        Frequency (Hz) array</span>

<span class="sd">    psd            : array, dtype=float</span>
<span class="sd">        Modified power-spectral density array (rad^2/Hz)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">freq</span><span class="p">,</span> <span class="n">psd</span> <span class="o">=</span> <span class="n">read_maos_psd</span><span class="p">(</span><span class="n">psd_input_file</span><span class="p">)</span>
    <span class="n">dfreq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>

    <span class="c1"># Create a vibration peak</span>
    <span class="n">vib_model</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">vib_freq</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">vib_model_psd</span> <span class="o">=</span> <span class="n">vib_model</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">radian</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">Hz</span>

    <span class="c1"># Normalize the vibration peak to have a total jitter as specified</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vib_model_psd</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">dfreq</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;arcsec&#39;</span><span class="p">)</span>
    <span class="n">vib_model_psd</span> <span class="o">*=</span> <span class="p">(</span><span class="n">vib_jitter_amp</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span> <span class="o">/</span> <span class="n">norm</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">psd</span> <span class="o">+=</span> <span class="n">vib_model_psd</span>
    <span class="k">return</span> <span class="n">freq</span><span class="p">,</span> <span class="n">psd</span></div>

    
<div class="viewcode-block" id="psd_integrate_sqrt">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.psd_integrate_sqrt.html#paarti.utils.maos_utils.psd_integrate_sqrt">[docs]</a>
<span class="k">def</span> <span class="nf">psd_integrate_sqrt</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">psd</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to integrate and take the square root of a PSD to give the total </span>
<span class="sd">    WFE or jitter.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    freq      : float</span>
<span class="sd">        Frequency (Hz) array</span>

<span class="sd">    psd       : float</span>
<span class="sd">        Power-spectral density array (rad^2/Hz)</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    total_rms : float</span>
<span class="sd">        Total RMS WFE</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dfreq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
    <span class="n">total_variance</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">psd</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span>
    <span class="n">total_rms</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_variance</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">total_rms</span></div>


<div class="viewcode-block" id="calc_strehl">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.calc_strehl.html#paarti.utils.maos_utils.calc_strehl">[docs]</a>
<span class="k">def</span> <span class="nf">calc_strehl</span><span class="p">(</span><span class="n">sim_dir</span><span class="p">,</span> <span class="n">out_file</span><span class="p">,</span> <span class="n">skysub</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sim_seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">apersize</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modified from KAI by Brooke DiGia</span>
<span class="sd">    (https://github.com/Keck-DataReductionPipelines/KAI/tree/dev)</span>
<span class="sd">    for use on MAOS-generated PSF files.</span>

<span class="sd">    Function to calculate the Strehl, root-mean-square (RMS) wave-front error</span>
<span class="sd">    (WFE), and full-width at half-maximum (FWHM) of a MAOS PSF stack.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    sim_dir          : str</span>
<span class="sd">        The directory where the MAOS simulation results live</span>

<span class="sd">    sim_seed         : int, default = 1</span>
<span class="sd">        The seed passed to MAOS for running the simulation</span>

<span class="sd">    out_file         : str</span>
<span class="sd">        The name of the output text file</span>

<span class="sd">    skysub           : boolean, default = False</span>
<span class="sd">        True to perform sky subtraction on PSF. Should be False for MAOS</span>
<span class="sd">        PSFs</span>

<span class="sd">    aper_size        : float, default = 0.3 arcsec</span>
<span class="sd">        The aperture size over which to calculate the Strehl and FWHM</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    strehl_to_return : array, len(nwvl), dtype=float</span>
<span class="sd">        Strehl values at each wavelength for which MAOS was run</span>

<span class="sd">    fwhm_to_return   : array, len(nwvl), dtype=float</span>
<span class="sd">        FWHM values at each wavelength</span>

<span class="sd">    rmswfe_to_return : array, len(nwvl), dtype=float</span>
<span class="sd">        RMS WFE values at each wavelength</span>

<span class="sd">    Function writes to user-specified output text file and prints</span>
<span class="sd">    results to terminal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Setup the output file and format.</span>
    <span class="n">_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="n">fmt_hdr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{img:&lt;3s}</span><span class="s1"> </span><span class="si">{strehl:&gt;10s}</span><span class="s1"> </span><span class="si">{rms:&gt;7s}</span><span class="s1"> </span><span class="si">{fwhm:&gt;7s}</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">fmt_dat</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{img:&lt;3f}</span><span class="s1"> </span><span class="si">{strehl:10.6f}</span><span class="s1"> </span><span class="si">{rms:7.1f}</span><span class="s1"> </span><span class="si">{fwhm:7.2f}</span><span class="se">\n</span><span class="s1">&#39;</span>
    
    <span class="n">_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt_hdr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">,</span> <span class="n">strehl</span><span class="o">=</span><span class="s1">&#39;Strehl&#39;</span><span class="p">,</span> <span class="n">rms</span><span class="o">=</span><span class="s1">&#39;RMSwfe&#39;</span><span class="p">,</span> 
                              <span class="n">fwhm</span><span class="o">=</span><span class="s1">&#39;FWHM&#39;</span><span class="p">))</span>
    <span class="n">_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt_hdr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="s1">&#39;(micron)&#39;</span><span class="p">,</span> <span class="n">strehl</span><span class="o">=</span><span class="s1">&#39;()&#39;</span><span class="p">,</span> <span class="n">rms</span><span class="o">=</span><span class="s1">&#39;(nm)&#39;</span><span class="p">,</span> 
                              <span class="n">fwhm</span><span class="o">=</span><span class="s1">&#39;(mas)&#39;</span><span class="p">))</span>

    <span class="c1"># Get the PSF .fits files from the input simulation directory</span>
    <span class="n">fits_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">sim_dir</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;evlpsfcl_</span><span class="si">{</span><span class="n">sim_seed</span><span class="si">}</span><span class="s1">_x0_y0.fits&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">fits_files</span><span class="p">)</span>
    <span class="n">psf_all_wvls</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fits_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">nwvl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">psf_all_wvls</span><span class="p">)</span>

    <span class="c1"># Get the diffraction limited image from the input simulation directory</span>
    <span class="n">dl_img_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">sim_dir</span> <span class="o">+</span> <span class="s1">&#39;evlpsfdl.fits&#39;</span><span class="p">)</span>
    <span class="n">dl_all_wvls</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dl_img_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Loop over the MAOS PSF stack to calculate metrics</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lambda (micron) | Strehl | RMS WFE (nm) | FWHM (mas)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------------------------------------------------------&quot;</span><span class="p">)</span>
    <span class="n">strehl_to_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nwvl</span><span class="p">)</span>
    <span class="n">fwhm_to_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nwvl</span><span class="p">)</span>
    <span class="n">rmswfe_to_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nwvl</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwvl</span><span class="p">):</span>
        <span class="c1"># Pull current PSF and DL image from stack</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="n">psf_all_wvls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">psf_all_wvls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="n">dl_img</span> <span class="o">=</span> <span class="n">dl_all_wvls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">dl_hdr</span> <span class="o">=</span> <span class="n">dl_all_wvls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

        <span class="c1"># DL wavelength (microns) and pixel scale (arcsec/px)</span>
        <span class="n">dl_lambda</span> <span class="o">=</span> <span class="n">dl_hdr</span><span class="p">[</span><span class="s2">&quot;WVL&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e6</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">dl_hdr</span><span class="p">[</span><span class="s2">&quot;DP&quot;</span><span class="p">]</span>

        <span class="c1"># PSF wavelength (microns)</span>
        <span class="n">psf_lambda</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;WVL&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e6</span>

        <span class="c1"># Check that DL wavelength and PSF wavelength are matched</span>
        <span class="k">if</span> <span class="n">dl_lambda</span> <span class="o">!=</span> <span class="n">psf_lambda</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: PSF wavelength does not match DL wavelength.&quot;</span><span class="p">)</span>
            <span class="n">_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># Pick appropriate extraction radius</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">apersize</span> <span class="o">/</span> <span class="n">scale</span><span class="p">))</span>
        <span class="c1"># In case the computed radius is too small...</span>
        <span class="k">if</span> <span class="n">radius</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="c1"># Perform some wide-aperture photometry on the </span>
        <span class="c1"># diffraction-limited image</span>
        <span class="n">peak_coords_dl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dl_img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> 
                                          <span class="n">dl_img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Calculate the peak flux ratio</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dl_peak_flux_ratio</span> <span class="o">=</span> <span class="n">calc_peak_flux_ratio</span><span class="p">(</span><span class="n">sim_dir</span><span class="p">,</span> <span class="n">dl_img</span><span class="p">,</span> 
                                                      <span class="n">peak_coords_dl</span><span class="p">,</span> 
                                                      <span class="n">radius</span><span class="p">,</span> <span class="n">dl_lambda</span><span class="p">,</span> 
                                                      <span class="n">skysub</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">astropy</span><span class="o">.</span><span class="n">nddata</span><span class="o">.</span><span class="n">PartialOverlapError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;astropy.nddata.PartialOverlapError&quot;</span><span class="p">)</span>
            <span class="n">_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># Calculate Strehl, FWHM, RMS WFE</span>
        <span class="n">strehl</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">rmswfe</span> <span class="o">=</span> <span class="n">calc_strehl_single</span><span class="p">(</span><span class="n">sim_dir</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> 
                                                  <span class="n">radius</span><span class="p">,</span> <span class="n">skysub</span><span class="p">,</span> 
                                                  <span class="n">dl_peak_flux_ratio</span><span class="p">)</span>
        <span class="n">strehl_to_return</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">strehl</span>
        <span class="n">fwhm_to_return</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwhm</span>
        <span class="n">rmswfe_to_return</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rmswfe</span>

        <span class="n">_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt_dat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">psf_lambda</span><span class="p">,</span> <span class="n">strehl</span><span class="o">=</span><span class="n">strehl</span><span class="p">,</span> 
                                  <span class="n">rms</span><span class="o">=</span><span class="n">rmswfe</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">fwhm</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">fmt_dat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">psf_lambda</span><span class="p">,</span> <span class="n">strehl</span><span class="o">=</span><span class="n">strehl</span><span class="p">,</span> 
                             <span class="n">rms</span><span class="o">=</span><span class="n">rmswfe</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">fwhm</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt; PSF peak flux value: </span><span class="si">%0.6f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">psf</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        # For plotting purposes:</span>
<span class="sd">        if psf_lambda == 2.12:</span>
<span class="sd">            plt.figure()</span>
<span class="sd">            plt.imshow(dl_img)</span>
<span class="sd">            plt.savefig(&quot;/u/bdigia/work/ao/single_psfs/good_run_psfs/test_maos_dl_plot.pdf&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="c1"># Close output file</span>
    <span class="n">_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">strehl_to_return</span><span class="p">,</span> <span class="n">fwhm_to_return</span><span class="p">,</span> <span class="n">rmswfe_to_return</span></div>


<div class="viewcode-block" id="calc_strehl_single">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.calc_strehl_single.html#paarti.utils.maos_utils.calc_strehl_single">[docs]</a>
<span class="k">def</span> <span class="nf">calc_strehl_single</span><span class="p">(</span><span class="n">sim_dir</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">skysub</span><span class="p">,</span> <span class="n">dl_peak_flux_ratio</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modified from KAI by Brooke DiGia </span>
<span class="sd">    (https://github.com/Keck-DataReductionPipelines/KAI/tree/dev)</span>
<span class="sd">    for use on MAOS-generated PSFs and diffraction-limited images.</span>

<span class="sd">    Function to calculate the Strehl for a single image PSF.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ----------</span>
<span class="sd">    sim_dir : string </span>
<span class="sd">        Simulation directory, output will be stored here</span>

<span class="sd">    psf     : array</span>
<span class="sd">        PSF data</span>

<span class="sd">    hdr     : dictionary </span>
<span class="sd">        FITS header associated with PSF data</span>

<span class="sd">    radius  : float</span>
<span class="sd">        Extraction radius in fitting</span>

<span class="sd">    skysub  : boolean </span>
<span class="sd">        True to perform sky subraction on PSF</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    strehl  : float</span>
<span class="sd">        Calculated Strehl value</span>

<span class="sd">    fwhm    : float</span>
<span class="sd">        Full-width at half-maximum of Gaussian fitted to input PSF</span>

<span class="sd">    rms_wfe : float</span>
<span class="sd">        Root-mean-square wave-front error (nm)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;WVL&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e6</span> <span class="c1"># microns</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;DP&quot;</span><span class="p">]</span>           <span class="c1"># arcsec/px</span>

    <span class="c1"># Coordinates of Strehl source (MAOS PSFs are output such that the</span>
    <span class="c1"># Strehl source is always centered in the image)</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">psf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span> <span class="p">,</span> <span class="n">psf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">])</span>

    <span class="c1"># First estimate the DL FWHM in pixels. Use this to set the initial boxsize </span>
    <span class="c1"># for the FWHM estimation...note that this is NOT the aperture size </span>
    <span class="c1"># specified above, which is only used for estimating the Strehl:</span>
    
    <span class="c1"># Keck telescope diameter in meters</span>
    <span class="n">telescope_diam</span> <span class="o">=</span> <span class="mf">10.5</span>
    <span class="n">dl_res_in_pix</span> <span class="o">=</span> <span class="p">(</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">wavelength</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="n">telescope_diam</span> <span class="o">*</span> <span class="n">scale</span> <span class="p">)</span>
    <span class="n">fwhm_min</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">dl_res_in_pix</span>
    <span class="n">fwhm_max</span> <span class="o">=</span> <span class="mf">100.0</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">fwhm_boxsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span> <span class="p">(</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">dl_res_in_pix</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">fwhm_boxsize</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">fwhm_boxsize</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">pos_delta_max</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">fwhm_min</span>
    <span class="n">box_scale</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">iters</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># Steadily increase the boxsize until we get a reasonable FWHM</span>
    <span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">fwhm</span> <span class="o">&lt;</span> <span class="n">fwhm_min</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fwhm</span> <span class="o">&gt;</span> <span class="n">fwhm_max</span><span class="p">)</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">iters</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">):</span>
        <span class="n">box_scale</span> <span class="o">+=</span> <span class="n">iters</span> <span class="o">*</span> <span class="mf">0.1</span>
        <span class="n">iters</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">g2d</span> <span class="o">=</span> <span class="n">fit_gaussian2d</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">fwhm_boxsize</span> <span class="o">*</span> <span class="n">box_scale</span><span class="p">,</span> 
                             <span class="n">fwhm_min</span><span class="o">=</span><span class="mf">0.8</span> <span class="o">*</span> <span class="n">fwhm_min</span><span class="p">,</span> <span class="n">fwhm_max</span><span class="o">=</span><span class="n">fwhm_max</span><span class="p">,</span>
                             <span class="n">pos_delta_max</span><span class="o">=</span><span class="n">pos_delta_max</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="p">(</span><span class="n">g2d</span><span class="o">.</span><span class="n">x_stddev_0</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">g2d</span><span class="o">.</span><span class="n">y_stddev_0</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">fwhm</span> <span class="o">=</span> <span class="n">stddev_to_fwhm</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

        <span class="c1"># Update the coordinates if they are reasonable. </span>
        <span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">g2d</span><span class="o">.</span><span class="n">x_mean_0</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">fwhm_boxsize</span><span class="p">)</span> <span class="ow">and</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">g2d</span><span class="o">.</span><span class="n">y_mean_0</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">fwhm_boxsize</span><span class="p">)):</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">g2d</span><span class="o">.</span><span class="n">x_mean_0</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">g2d</span><span class="o">.</span><span class="n">y_mean_0</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>

    <span class="c1"># Convert to milli-arcseconds</span>
    <span class="n">fwhm</span> <span class="o">*=</span> <span class="n">scale</span> <span class="o">*</span> <span class="mf">1e3</span>

    <span class="c1"># Calculate the peak flux ratio</span>
    <span class="n">peak_flux_ratio</span> <span class="o">=</span> <span class="n">calc_peak_flux_ratio</span><span class="p">(</span><span class="n">sim_dir</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> 
                                           <span class="n">wavelength</span><span class="p">,</span> <span class="n">skysub</span><span class="p">)</span>
    <span class="c1"># Normalize by the same from the DL image to get the Strehl</span>
    <span class="n">strehl</span> <span class="o">=</span> <span class="n">peak_flux_ratio</span> <span class="o">/</span> <span class="n">dl_peak_flux_ratio</span>

    <span class="c1"># Convert the Strehl to a RMS WFE using the Marechal approximation</span>
    <span class="n">rms_wfe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">strehl</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">wavelength</span> <span class="o">*</span> <span class="mf">1.0e3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="p">)</span>
    
    <span class="c1"># Check final values and fail gracefully.</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">strehl</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">strehl</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span><span class="n">fwhm</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fwhm</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">fwhm_min</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">))):</span>
        
        <span class="n">strehl</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">fwhm</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">rms_wfe</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">return</span> <span class="n">strehl</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">rms_wfe</span></div>


<div class="viewcode-block" id="calc_peak_flux_ratio">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.calc_peak_flux_ratio.html#paarti.utils.maos_utils.calc_peak_flux_ratio">[docs]</a>
<span class="k">def</span> <span class="nf">calc_peak_flux_ratio</span><span class="p">(</span><span class="n">sim_dir</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">skysub</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modified from KAI by Brooke DiGia for use on MAOS-generated PSFs.</span>
<span class="sd">    Function to calculate the ratio of peak flux in the input PSF image</span>
<span class="sd">    to the sum of the PSF pixel values. Optional plotting routine to</span>
<span class="sd">    visually inspect the sky subtraction annulus (if skysub is turned on).</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    sim_dir         : string</span>
<span class="sd">        Simulation directory</span>

<span class="sd">    img             : 2D numpy array</span>
<span class="sd">        The image on which to calculate the flux ratio of the peak to a </span>
<span class="sd">        wide-aperture</span>

<span class="sd">    coords          : list or numpy array, length = 2</span>
<span class="sd">        The x and y position of the source</span>

<span class="sd">    radius          : int</span>
<span class="sd">        The radius, in pixels, of the wide-aperture </span>

<span class="sd">    wavelength      : float</span>
<span class="sd">        Wavelength of the associated img/PSF for plotting purposes</span>

<span class="sd">    skysub          : boolean</span>
<span class="sd">        True to perform sky subtraction on PSF</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    peak_flux_ratio : float</span>
<span class="sd">        Peak flux ratio</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Determine the peak flux</span>
    <span class="n">peak_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> 
                                             <span class="n">img</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">peak_flux</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">peak_coords</span><span class="p">]</span>
    
    <span class="c1"># Calculate the Strehl by first finding the peak-pixel flux / </span>
    <span class="c1"># wide-aperture flux. Then normalize by the same thing from </span>
    <span class="c1"># the reference DL image. </span>
    <span class="n">aper_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">skysub</span><span class="p">:</span>
        <span class="n">sky_rad_inn</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">20</span>
        <span class="n">sky_rad_out</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">30</span>
        <span class="n">sky_aper</span> <span class="o">=</span> <span class="n">CircularAnnulus</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">sky_rad_inn</span><span class="p">,</span> <span class="n">sky_rad_out</span><span class="p">)</span>
        <span class="n">sky_aper_out</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">sky_aper</span><span class="p">)</span>
        <span class="n">sky_aper_sum</span> <span class="o">=</span> <span class="n">sky_aper_out</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">aper_sum</span> <span class="o">-=</span> <span class="n">sky_aper_sum</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
        <span class="n">annulus_patches</span> <span class="o">=</span> <span class="n">sky_aper</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Annulus&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;MAOS PSF at </span><span class="si">%0.2f</span><span class="s2"> microns&quot;</span> <span class="o">%</span> <span class="n">wavelength</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/PSF_annuli_</span><span class="si">%0.2f</span><span class="s2">_microns.pdf&quot;</span> <span class="o">%</span> 
                    <span class="p">(</span><span class="n">sim_dir</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">))</span>

    <span class="c1"># Calculate the peak pixel flux / wide-aperture flux</span>
    <span class="n">peak_flux_ratio</span> <span class="o">=</span> <span class="n">peak_flux</span> <span class="o">/</span> <span class="n">aper_sum</span>
    <span class="k">return</span> <span class="n">peak_flux_ratio</span></div>


<div class="viewcode-block" id="fit_gaussian2d">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.fit_gaussian2d.html#paarti.utils.maos_utils.fit_gaussian2d">[docs]</a>
<span class="k">def</span> <span class="nf">fit_gaussian2d</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fwhm_min</span><span class="o">=</span><span class="mf">1.7</span><span class="p">,</span> 
                   <span class="n">fwhm_max</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">pos_delta_max</span><span class="o">=</span><span class="mf">1.7</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the FWHM of an objected located at the pixel</span>
<span class="sd">    coordinates in the image. The FWHM will be estimated </span>
<span class="sd">    from a cutout with the specified boxsize. Adopted from</span>
<span class="sd">    the KAI repository (linked in functions above).</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    img           : ndarray, 2D</span>
<span class="sd">        The image where a star is located for calculating a FWHM</span>

<span class="sd">    coords        : len=2 ndarray</span>
<span class="sd">        The [x, y] pixel position of the star in the image</span>

<span class="sd">    boxsize       : int</span>
<span class="sd">        The size of the box (on the side), in pixels</span>

<span class="sd">    fwhm_min      : float, optional</span>
<span class="sd">        The minimum allowed FWHM for constraining the fit (pixels)</span>

<span class="sd">    fwhm_max      : float, optional</span>
<span class="sd">        The maximum allowed FWHM for constraining the fit (pixels)</span>

<span class="sd">    pos_delta_max : float, optional</span>
<span class="sd">        The maximum allowed positional offset for constraining the fit (px)</span>
<span class="sd">        This ensures that the fitter doesn&#39;t wander off to a bad pixel</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    g2d           : Gaussian model object</span>
<span class="sd">        2D Gaussian fit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cutout_obj</span> <span class="o">=</span> <span class="n">Cutout2D</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;strict&#39;</span><span class="p">)</span>
    <span class="n">cutout</span> <span class="o">=</span> <span class="n">cutout_obj</span><span class="o">.</span><span class="n">data</span>
    <span class="n">x1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cutout</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cutout</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">x2d</span><span class="p">,</span> <span class="n">y2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x1d</span><span class="p">,</span> <span class="n">y1d</span><span class="p">)</span>
    
    <span class="c1"># Setup our model with some initial guess</span>
    <span class="n">x_init</span> <span class="o">=</span> <span class="n">boxsize</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">y_init</span> <span class="o">=</span> <span class="n">boxsize</span><span class="o">/</span><span class="mf">2.0</span>
    
    <span class="n">x_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cutout</span><span class="p">),</span> <span class="n">cutout</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">y_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cutout</span><span class="p">),</span> <span class="n">cutout</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">stddev_init</span> <span class="o">=</span> <span class="n">fwhm_to_stddev</span><span class="p">(</span><span class="n">fwhm_min</span><span class="p">)</span>
    
    <span class="n">g2d_init</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian2D</span><span class="p">(</span><span class="n">x_mean</span> <span class="o">=</span> <span class="n">x_init</span><span class="p">,</span>
                                 <span class="n">y_mean</span> <span class="o">=</span> <span class="n">y_init</span><span class="p">,</span>
                                 <span class="n">x_stddev</span> <span class="o">=</span> <span class="n">stddev_init</span><span class="p">,</span>
                                 <span class="n">y_stddev</span> <span class="o">=</span> <span class="n">stddev_init</span><span class="p">,</span>
                                 <span class="n">amplitude</span><span class="o">=</span><span class="n">cutout</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">g2d_init</span> <span class="o">+=</span> <span class="n">models</span><span class="o">.</span><span class="n">Const2D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">g2d_init</span><span class="o">.</span><span class="n">x_stddev_0</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">fwhm_to_stddev</span><span class="p">(</span><span class="n">fwhm_min</span><span class="p">)</span>
    <span class="n">g2d_init</span><span class="o">.</span><span class="n">y_stddev_0</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">fwhm_to_stddev</span><span class="p">(</span><span class="n">fwhm_min</span><span class="p">)</span>
    <span class="n">g2d_init</span><span class="o">.</span><span class="n">x_stddev_0</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">fwhm_to_stddev</span><span class="p">(</span><span class="n">fwhm_max</span><span class="p">)</span>
    <span class="n">g2d_init</span><span class="o">.</span><span class="n">y_stddev_0</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">fwhm_to_stddev</span><span class="p">(</span><span class="n">fwhm_max</span><span class="p">)</span>
    
    <span class="n">g2d_init</span><span class="o">.</span><span class="n">x_mean_0</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">x_init</span> <span class="o">-</span> <span class="n">pos_delta_max</span>
    <span class="n">g2d_init</span><span class="o">.</span><span class="n">x_mean_0</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">x_init</span> <span class="o">+</span> <span class="n">pos_delta_max</span>
    <span class="n">g2d_init</span><span class="o">.</span><span class="n">y_mean_0</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">y_init</span> <span class="o">-</span> <span class="n">pos_delta_max</span>
    <span class="n">g2d_init</span><span class="o">.</span><span class="n">y_mean_0</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">y_init</span> <span class="o">+</span> <span class="n">pos_delta_max</span>
    
    <span class="n">fit_g</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
    <span class="n">g2d</span> <span class="o">=</span> <span class="n">fit_g</span><span class="p">(</span><span class="n">g2d_init</span><span class="p">,</span> <span class="n">x2d</span><span class="p">,</span> <span class="n">y2d</span><span class="p">,</span> <span class="n">cutout</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">mod_img</span> <span class="o">=</span> <span class="n">g2d</span><span class="p">(</span><span class="n">x2d</span><span class="p">,</span> <span class="n">y2d</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cutout</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">mod_img</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">mod_img</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                   <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Original&quot;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mod_img</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">mod_img</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">mod_img</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                   <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Model&quot;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cutout</span> <span class="o">-</span> <span class="n">mod_img</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Orig - Mod&quot;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
        <span class="c1"># plt.show(block=0)</span>
        <span class="c1"># plt.savefig(&#39;strehl_fit.pdf&#39;)</span>
        <span class="c1"># pdb.set_trace()</span>
        
    <span class="c1"># Adjust Gaussian parameters to the original coordinates.</span>
    <span class="n">cutout_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">g2d</span><span class="o">.</span><span class="n">x_mean_0</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">g2d</span><span class="o">.</span><span class="n">y_mean_0</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
    <span class="n">origin_pos</span> <span class="o">=</span> <span class="n">cutout_obj</span><span class="o">.</span><span class="n">to_original_position</span><span class="p">(</span><span class="n">cutout_pos</span><span class="p">)</span>
    <span class="n">g2d</span><span class="o">.</span><span class="n">x_mean_0</span> <span class="o">=</span> <span class="n">origin_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">g2d</span><span class="o">.</span><span class="n">y_mean_0</span> <span class="o">=</span> <span class="n">origin_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">g2d</span></div>

    
<div class="viewcode-block" id="fwhm_to_stddev">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.fwhm_to_stddev.html#paarti.utils.maos_utils.fwhm_to_stddev">[docs]</a>
<span class="k">def</span> <span class="nf">fwhm_to_stddev</span><span class="p">(</span><span class="n">fwhm</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to convert input full-width at half-maximum to standard</span>
<span class="sd">    deviation, assuming a Gaussian distribution.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    fwhm  : float</span>
<span class="sd">        Full-width at half-maximum</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    sigma : float</span>
<span class="sd">        Standard deviation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">fwhm</span> <span class="o">/</span> <span class="p">(</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">sigma</span></div>


<div class="viewcode-block" id="stddev_to_fwhm">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.stddev_to_fwhm.html#paarti.utils.maos_utils.stddev_to_fwhm">[docs]</a>
<span class="k">def</span> <span class="nf">stddev_to_fwhm</span><span class="p">(</span><span class="n">stddev</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to convert input standard deviation to full-width at</span>
<span class="sd">    half-maximum, assuming a Gaussian distribution.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    stddev : float</span>
<span class="sd">        Standard deviation</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    fwhm   : float</span>
<span class="sd">        Full-width at half-maximum</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
    <span class="k">return</span> <span class="n">fwhm</span> </div>


<div class="viewcode-block" id="fried">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.fried.html#paarti.utils.maos_utils.fried">[docs]</a>
<span class="k">def</span> <span class="nf">fried</span><span class="p">(</span><span class="n">DIMM</span><span class="p">,</span> <span class="n">wvl</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate the Fried parameter r0z given the total seeing</span>
<span class="sd">    in arcseconds.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    DIMM : float</span>
<span class="sd">        DIMM seeing, arcsec </span>
<span class="sd">    </span>
<span class="sd">    wvl  : float</span>
<span class="sd">        Wavelength in nm, default is 500 nm</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    r0z  : float</span>
<span class="sd">        The Fried parameter, r0z, in meters</span>

<span class="sd">    By Brooke DiGia</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">r0z</span> <span class="o">=</span> <span class="mf">0.98</span> <span class="o">*</span> <span class="p">(</span> <span class="n">wvl</span><span class="o">*</span><span class="mf">1e-9</span> <span class="o">/</span> <span class="n">arcsec_to_rad</span><span class="p">(</span><span class="n">DIMM</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">r0z</span></div>


<div class="viewcode-block" id="arcsec_to_rad">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.arcsec_to_rad.html#paarti.utils.maos_utils.arcsec_to_rad">[docs]</a>
<span class="k">def</span> <span class="nf">arcsec_to_rad</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to convert input quantity from arcseconds to radians.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    x : float </span>
<span class="sd">        Quantity to be converted from arcsec to radians</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    x : float</span>
<span class="sd">        Desired quantity in radians</span>

<span class="sd">    By Brooke DiGia</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">3600.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span><span class="p">)</span></div>


<div class="viewcode-block" id="estimate_turbulence">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.estimate_turbulence.html#paarti.utils.maos_utils.estimate_turbulence">[docs]</a>
<span class="k">def</span> <span class="nf">estimate_turbulence</span><span class="p">(</span><span class="n">dimm</span><span class="p">,</span> <span class="n">mass_wts</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">wvl</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> 
                        <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Based on equations 16-19 in KAON496:</span>
<span class="sd">    https://www.oir.caltech.edu/twiki_oir/pub/Keck/NGAO/NewKAONs/KAON496.pdf</span>

<span class="sd">    Function to estimate the full turbulence profile (ground layer + free</span>
<span class="sd">    atmosphere) of a particular night for which MASS and DIMM data was </span>
<span class="sd">    recorded.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    dimm      : float</span>
<span class="sd">        Total seeing (arcsec) from DIMM data file</span>

<span class="sd">    mass_wts  : 6-entry 1D array, floats</span>
<span class="sd">        c_l weights from MASS data file. Response from </span>
<span class="sd">        Mark Chun verifies that MASS file entries are indeed Cn^2*delta_h,</span>
<span class="sd">        as opposed to pure Cn^2 values. Cn^2*delta_h = c_l.</span>

<span class="sd">    date      : string</span>
<span class="sd">        Date of MASS/DIMM data; used only for plot filename and labels</span>

<span class="sd">    plot      : boolean</span>
<span class="sd">        Option to plot turbulence profile after calculation and save to</span>
<span class="sd">        current working directory</span>

<span class="sd">    wvl       : float, default = 500 nm</span>
<span class="sd">        Wavelength involved in calculation</span>

<span class="sd">    normalize : boolean, default = True</span>
<span class="sd">        Option to normalize calculated turbulence profile</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    wts       : 7-entry 1D array, floats</span>
<span class="sd">        Full turbulence profile with estimated ground layer weight</span>

<span class="sd">    r0        : float</span>
<span class="sd">        Fried parameter (meters)</span>

<span class="sd">    By Brooke DiGia</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate 0th order turbulence moment</span>
    <span class="n">r0</span> <span class="o">=</span> <span class="n">fried</span><span class="p">(</span><span class="n">dimm</span><span class="p">,</span> <span class="n">wvl</span><span class="p">)</span>
    <span class="n">mu0</span> <span class="o">=</span> <span class="mf">0.06</span> <span class="o">*</span> <span class="p">(</span> <span class="n">wvl</span><span class="o">*</span><span class="mf">1e-9</span> <span class="p">)</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">r0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">5.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>

    <span class="n">c0</span> <span class="o">=</span> <span class="n">mu0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mass_wts</span><span class="p">)</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mass_wts</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">to_normalize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">mass_wts</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c0</span><span class="p">)</span>
        <span class="n">tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">to_normalize</span><span class="p">)</span>

        <span class="c1"># Re-normalize turbulence weights with new ground layer entry</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">to_normalize</span><span class="o">/</span><span class="n">tot</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">mass_wts</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">hts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">500.0</span><span class="p">,</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="mf">2000.0</span><span class="p">,</span> <span class="mf">4000.0</span><span class="p">,</span> <span class="mf">8000.0</span><span class="p">,</span> <span class="mf">16000.0</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hts</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;ro&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Turbulence profile </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">date</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;c_</span><span class="si">{l}</span><span class="s2"> coefficients&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Height above telescope (meters)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;turb_profile_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">date</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r0</span><span class="p">,</span> <span class="bp">cls</span></div>


<div class="viewcode-block" id="fetch_mass_dimm_cfht_loc">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.fetch_mass_dimm_cfht_loc.html#paarti.utils.maos_utils.fetch_mass_dimm_cfht_loc">[docs]</a>
<span class="k">def</span> <span class="nf">fetch_mass_dimm_cfht_loc</span><span class="p">(</span><span class="n">dimm_in_hrs</span><span class="p">,</span> <span class="n">mass_in_hrs</span><span class="p">,</span> 
                             <span class="n">cfht_in_hrs</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to fetch the MASS/DIMM/CFHT data that is closest to </span>
<span class="sd">    the input timestamp.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    dimm_in_hrs : float, array with length of data file</span>
<span class="sd">        DIMM time data expressed in hours</span>

<span class="sd">    mass_in_hrs : float, array with length of data file</span>
<span class="sd">        MASS time data expressed in hours</span>

<span class="sd">    cfht_in_hrs : float, variable length</span>
<span class="sd">        CFHT time data expressed in hours</span>

<span class="sd">    timestamp   : float</span>
<span class="sd">        Time for which to find the closest corresponding </span>
<span class="sd">        MASS/DIMM/CFHT data</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    dimm_idx    : int</span>
<span class="sd">        Index where closest DIMM data lies in DIMM file</span>

<span class="sd">    mass_idx    : int</span>
<span class="sd">        Index where closest MASS data lies in MASS file</span>

<span class="sd">    cfht_idx    : int</span>
<span class="sd">        Index where closest CFHT data lies in input CFHT subset</span>

<span class="sd">    By Brooke DiGia</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dimm_time_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dimm_in_hrs</span> <span class="o">-</span> <span class="n">timestamp</span><span class="p">)</span>
    <span class="n">mass_time_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mass_in_hrs</span> <span class="o">-</span> <span class="n">timestamp</span><span class="p">)</span>
    <span class="n">cfht_time_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cfht_in_hrs</span> <span class="o">-</span> <span class="n">timestamp</span><span class="p">)</span>
    <span class="n">dimm_closest_idx</span> <span class="o">=</span> <span class="n">dimm_time_diff</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    <span class="n">mass_closest_idx</span> <span class="o">=</span> <span class="n">mass_time_diff</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    <span class="n">cfht_closest_idx</span> <span class="o">=</span> <span class="n">cfht_time_diff</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">dimm_time_diff</span><span class="p">[</span><span class="n">dimm_closest_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not locate DIMM data close to &quot;</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">mass_time_diff</span><span class="p">[</span><span class="n">mass_closest_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not locate MASS data close to &quot;</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cfht_time_diff</span><span class="p">[</span><span class="n">cfht_closest_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not locate CFHT data close to &quot;</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dimm_closest_idx</span><span class="p">,</span> <span class="n">mass_closest_idx</span><span class="p">,</span> <span class="n">cfht_closest_idx</span></div>


<div class="viewcode-block" id="remove_keywords">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.remove_keywords.html#paarti.utils.maos_utils.remove_keywords">[docs]</a>
<span class="k">def</span> <span class="nf">remove_keywords</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to remove XSTREHL and YSTREHL keywords from input FITS </span>
<span class="sd">    file headers. E.g. to remove these keywords from the on-sky </span>
<span class="sd">    NIRC2 GC FITS files so that KAI&#39;s calc_strehl routine (modified </span>
<span class="sd">    MAOS version above) does not use these XSTREHL and YSTREHL </span>
<span class="sd">    coordinates for source coordinates when input FITS files are </span>
<span class="sd">    PSFs (which by definition are centered on the Strehl source).</span>

<span class="sd">    Inputs:</span>
<span class="sd">    -----------</span>
<span class="sd">    file       : string</span>
<span class="sd">        Path to FITS file to be edited</span>

<span class="sd">    *args : string(s)</span>
<span class="sd">        Keyword(s) to be removed from input FITS file header</span>

<span class="sd">    Outputs:</span>
<span class="sd">    -----------</span>
<span class="sd">    None, input FITS file is revised in directory where it lives</span>
<span class="sd">    </span>
<span class="sd">    By Brooke DiGia</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load header from input FITS file</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">fits_file</span><span class="p">:</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Remove all input keywords</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing keyword &#39;</span><span class="si">%s</span><span class="s2">&#39; from </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
            <span class="k">del</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>

        <span class="c1"># Overwrite original input file with desired changes</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
    <span class="k">return</span></div>


<div class="viewcode-block" id="estimate_on_sky_conditions">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.estimate_on_sky_conditions.html#paarti.utils.maos_utils.estimate_on_sky_conditions">[docs]</a>
<span class="k">def</span> <span class="nf">estimate_on_sky_conditions</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">saveto</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to take in the path to an on-sky .fits file (containing a PSF)</span>
<span class="sd">    and return an estimation of the atmospheric conditions present at the</span>
<span class="sd">    time of on-sky observation. The on-sky filename date and FITS header</span>
<span class="sd">    exposure start/stop times are recorded in UT. The MASS and DIMM contents</span>
<span class="sd">    are recorded in local Hawaiian time (HST), so this function will convert</span>
<span class="sd">    the MASS/DIMM data to UT. Likewise, the CFHT meteogram data is recorded</span>
<span class="sd">    in HST, so that data will be converted as well. The PHTO Hilo data is</span>
<span class="sd">    taken only twice per day, so this data does not need to be searched</span>
<span class="sd">    for the entry closest to the FITS exposure time. Instead, we search</span>
<span class="sd">    the PHTO data for the entries closest to the telescope heights</span>
<span class="sd">    in the MAOS atm config file.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    file             : string</span>
<span class="sd">        Path to on-sky FITS file</span>

<span class="sd">    saveto           : string</span>
<span class="sd">        Path of location to save MASS/DIMM data files</span>

<span class="sd">    plot             : boolean, default = False</span>
<span class="sd">        Option to plot turbulence profile and save to current working </span>
<span class="sd">        directory</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    avg_r0           : float</span>
<span class="sd">        Averaged Fried parameter in meters</span>

<span class="sd">    full_turb        : array, len=7, dtype=float</span>
<span class="sd">        Full turbulence profile (ground layer + free atmosphere)</span>

<span class="sd">    wind_spd_profile : array, len=7, dtype=float</span>
<span class="sd">        Full wind speed profile</span>

<span class="sd">    wind_dir_profile : array, len=7, dtype=float</span>
<span class="sd">        Full wind direction profile</span>
<span class="sd">    </span>
<span class="sd">    By Brooke DiGia</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NOTE: Results for MAOS configuration files marked with ***</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">fits_file</span><span class="p">:</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">data</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span>
        
        <span class="c1"># Date of observation, parsed into year, month, day (UT)</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">date</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">month</span> <span class="o">=</span> <span class="n">date</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">day</span> <span class="o">=</span> <span class="n">date</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">date_for_massdimm</span> <span class="o">=</span> <span class="n">year</span> <span class="o">+</span> <span class="n">month</span> <span class="o">+</span> <span class="n">day</span>
        
        <span class="c1"># Pull MASS and DIMM files corresponding to date of observation</span>
        <span class="c1"># if they are not already present in save_dir directory</span>
        <span class="n">dimmdat</span> <span class="o">=</span> <span class="n">date_for_massdimm</span> <span class="o">+</span> <span class="s2">&quot;.dimm.dat&quot;</span>
        <span class="n">masspro</span> <span class="o">=</span> <span class="n">date_for_massdimm</span> <span class="o">+</span> <span class="s2">&quot;.masspro.dat&quot;</span>
        <span class="n">url_root</span> <span class="o">=</span> <span class="s2">&quot;http://mkwc.ifa.hawaii.edu/current/seeing/&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url_root</span> <span class="o">+</span> <span class="s2">&quot;dimm/&quot;</span> <span class="o">+</span> <span class="n">dimmdat</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dimmdat</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Pull and save DIMM file</span>
                <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">saveto</span> <span class="o">+</span> <span class="n">dimmdat</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dimmdat</span><span class="si">}</span><span class="s2"> saved to </span><span class="si">{</span><span class="n">saveto</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while downloading </span><span class="si">{</span><span class="n">dimmdat</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">,</span> 
                      <span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dimmdat</span><span class="si">}</span><span class="s2"> exists in directory </span><span class="si">{</span><span class="n">saveto</span><span class="si">}</span><span class="s2">, not downloading.&quot;</span><span class="p">)</span>

        <span class="c1"># Reset url</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url_root</span> <span class="o">+</span> <span class="s2">&quot;masspro/&quot;</span> <span class="o">+</span> <span class="n">masspro</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">masspro</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Pull and save MASS file</span>
                <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">saveto</span> <span class="o">+</span> <span class="n">masspro</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">masspro</span><span class="si">}</span><span class="s2"> saved to </span><span class="si">{</span><span class="n">saveto</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while downloading </span><span class="si">{</span><span class="n">masspro</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">,</span> 
                      <span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">masspro</span><span class="si">}</span><span class="s2"> exists in directory </span><span class="si">{</span><span class="n">saveto</span><span class="si">}</span><span class="s2">, not downloading.&quot;</span><span class="p">)</span>

        <span class="c1"># Pull CFHT data based on year of observation date</span>
        <span class="n">cfht_url</span> <span class="o">=</span> <span class="s2">&quot;http://mkwc.ifa.hawaii.edu/archive/wx/cfht/cfht-wx.</span><span class="si">%s</span><span class="s2">.dat&quot;</span> <span class="o">%</span> <span class="n">year</span>
        <span class="n">cfht</span> <span class="o">=</span> <span class="s2">&quot;cfht-wx.</span><span class="si">%s</span><span class="s2">.dat&quot;</span> <span class="o">%</span> <span class="n">year</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cfht</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">cfht_url</span><span class="p">,</span> <span class="n">saveto</span> <span class="o">+</span> <span class="n">cfht</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cfht</span><span class="si">}</span><span class="s2"> saved to </span><span class="si">{</span><span class="n">saveto</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while downloading </span><span class="si">{</span><span class="n">cfht</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">cfht_url</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">,</span>
                      <span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cfht</span><span class="si">}</span><span class="s2"> exists in directory </span><span class="si">{</span><span class="n">saveto</span><span class="si">}</span><span class="s2">, not downloading.&quot;</span><span class="p">)</span>

        <span class="c1"># Pull PHTO station data based on year of observation date</span>
        <span class="n">phto_url</span> <span class="o">=</span> <span class="s2">&quot;http://weather.uwyo.edu/cgi-bin/sounding?region=naconf&amp;TYPE=TEXT%3ALIST&amp;YEAR=&quot;</span> <span class="o">+</span> <span class="n">year</span> <span class="o">+</span> <span class="s2">&quot;&amp;MONTH=&quot;</span> <span class="o">+</span> <span class="n">month</span> <span class="o">+</span> <span class="s2">&quot;&amp;FROM=&quot;</span> <span class="o">+</span> <span class="n">day</span> <span class="o">+</span> <span class="s2">&quot;00&amp;TO=&quot;</span> <span class="o">+</span> <span class="n">day</span> <span class="o">+</span> <span class="s2">&quot;00&amp;STNM=91285&quot;</span>

        <span class="n">phto</span> <span class="o">=</span> <span class="s2">&quot;phto.</span><span class="si">%s</span><span class="s2">.dat&quot;</span> <span class="o">%</span> <span class="n">date_for_massdimm</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">phto</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">phto_url</span><span class="p">,</span> <span class="n">saveto</span> <span class="o">+</span> <span class="n">phto</span><span class="p">)</span>
                <span class="c1"># page = requests.get(phto_url)</span>
                <span class="c1"># contents = page.text</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phto</span><span class="si">}</span><span class="s2"> saved to </span><span class="si">{</span><span class="n">saveto</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while downloading </span><span class="si">{</span><span class="n">phto</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">phto_url</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">,</span>
                      <span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
                <span class="c1">#return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phto</span><span class="si">}</span><span class="s2"> exists in directory </span><span class="si">{</span><span class="n">saveto</span><span class="si">}</span><span class="s2">, not downloading.&quot;</span><span class="p">)</span>

        <span class="c1"># Exposure time on this date, parsed into hour, minute, second (UT)</span>
        <span class="n">expstart</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;EXPSTART&quot;</span><span class="p">]</span>
        <span class="n">expstop</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;EXPSTOP&quot;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Date of observation is  </span><span class="si">%s</span><span class="s2"> (UT)&quot;</span> <span class="o">%</span> <span class="n">date</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exposure time is</span><span class="se">\t</span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2"> (UT)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">expstart</span><span class="p">,</span> <span class="n">expstop</span><span class="p">))</span>
        <span class="n">expstart_hr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">expstart</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">expstart_min</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">expstart</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">expstart_sec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">expstart</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
        <span class="n">expstop_hr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">expstop</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">expstop_min</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">expstop</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">expstop_sec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">expstop</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
        
        <span class="c1"># Load in DIMM data and parse into individual arrays</span>
        <span class="n">dimm_table</span> <span class="o">=</span> <span class="n">read_csv</span><span class="p">(</span><span class="n">saveto</span> <span class="o">+</span> <span class="n">dimmdat</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span>\
                             <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;minute&#39;</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">,</span> \
                             <span class="s1">&#39;seeing&#39;</span><span class="p">])</span>
        <span class="n">dimm_yr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dimm_table</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">])</span>
        <span class="n">dimm_mon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dimm_table</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">])</span>
        <span class="n">dimm_day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dimm_table</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">])</span>
        <span class="n">dimm_hr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dimm_table</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">])</span>
        <span class="n">dimm_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dimm_table</span><span class="p">[</span><span class="s1">&#39;minute&#39;</span><span class="p">])</span>
        <span class="n">dimm_sec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dimm_table</span><span class="p">[</span><span class="s1">&#39;second&#39;</span><span class="p">])</span>
        <span class="n">dimm_seeing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dimm_table</span><span class="p">[</span><span class="s1">&#39;seeing&#39;</span><span class="p">])</span>

        <span class="c1"># Convert DIMM data from local Hawaiian time (HST) to UT to match FITS</span>
        <span class="c1"># date of observation and exposure time</span>
        <span class="n">dimm_hr</span> <span class="o">+=</span> <span class="mi">10</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dimm_hr</span> <span class="o">&gt;=</span> <span class="mi">24</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dimm_day</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">dimm_hr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">24</span>

        <span class="c1"># Create array with DIMM time data expressed in only hours</span>
        <span class="n">dimm_time_in_hrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dimm_hr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">dimm_min</span><span class="p">,</span> <span class="mf">60.0</span><span class="p">),</span> 
                                  <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">dimm_sec</span><span class="p">,</span> <span class="mf">3600.0</span><span class="p">))</span>

        <span class="c1"># Load in MASS data and parse into individual arrays</span>
        <span class="n">mass_table</span> <span class="o">=</span> <span class="n">read_csv</span><span class="p">(</span><span class="n">saveto</span> <span class="o">+</span> <span class="n">masspro</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span>\
                             <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;minute&#39;</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">,</span> \
                              <span class="s1">&#39;cn2dh_05&#39;</span><span class="p">,</span> <span class="s1">&#39;cn2dh_1&#39;</span><span class="p">,</span> <span class="s1">&#39;cn2dh_2&#39;</span><span class="p">,</span> <span class="s1">&#39;cn2dh_4&#39;</span><span class="p">,</span> \
                              <span class="s1">&#39;cn2dh_8&#39;</span><span class="p">,</span> <span class="s1">&#39;cn2dh_16&#39;</span><span class="p">,</span> <span class="s1">&#39;seeing&#39;</span><span class="p">])</span>
        <span class="n">mass_yr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass_table</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">])</span>
        <span class="n">mass_mon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass_table</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">])</span>
        <span class="n">mass_day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass_table</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">])</span>
        <span class="n">mass_hr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass_table</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">])</span>
        <span class="n">mass_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass_table</span><span class="p">[</span><span class="s1">&#39;minute&#39;</span><span class="p">])</span>
        <span class="n">mass_sec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass_table</span><span class="p">[</span><span class="s1">&#39;second&#39;</span><span class="p">])</span>
        <span class="n">mass_cn2dh05</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass_table</span><span class="p">[</span><span class="s1">&#39;cn2dh_05&#39;</span><span class="p">])</span>
        <span class="n">mass_cn2dh1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass_table</span><span class="p">[</span><span class="s1">&#39;cn2dh_1&#39;</span><span class="p">])</span>
        <span class="n">mass_cn2dh2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass_table</span><span class="p">[</span><span class="s1">&#39;cn2dh_2&#39;</span><span class="p">])</span>
        <span class="n">mass_cn2dh4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass_table</span><span class="p">[</span><span class="s1">&#39;cn2dh_4&#39;</span><span class="p">])</span>
        <span class="n">mass_cn2dh8</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass_table</span><span class="p">[</span><span class="s1">&#39;cn2dh_8&#39;</span><span class="p">])</span>
        <span class="n">mass_cn2dh16</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass_table</span><span class="p">[</span><span class="s1">&#39;cn2dh_16&#39;</span><span class="p">])</span>
        <span class="n">mass_seeing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass_table</span><span class="p">[</span><span class="s1">&#39;seeing&#39;</span><span class="p">])</span>

        <span class="c1"># Convert MASS data from HST to UT</span>
        <span class="n">mass_hr</span> <span class="o">+=</span> <span class="mi">10</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mass_hr</span> <span class="o">&gt;=</span> <span class="mi">24</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mass_day</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">mass_hr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">24</span>

        <span class="c1"># Create array with MASS time data in hours</span>
        <span class="n">mass_time_in_hrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mass_hr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">mass_min</span><span class="p">,</span> <span class="mf">60.0</span><span class="p">),</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">mass_sec</span><span class="p">,</span> <span class="mf">3600.0</span><span class="p">))</span>

        <span class="c1"># Load in CFHT data and parse into individual arrays</span>
        <span class="n">cfht_table</span> <span class="o">=</span> <span class="n">read_csv</span><span class="p">(</span><span class="n">saveto</span> <span class="o">+</span> <span class="n">cfht</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span>\
                             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> \
                                                           <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;minute&#39;</span><span class="p">,</span> \
                                                           <span class="s1">&#39;wdspd&#39;</span><span class="p">,</span> <span class="s1">&#39;wddir&#39;</span><span class="p">])</span>
        <span class="n">cfht_yr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cfht_table</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">])</span>
        <span class="n">cfht_mon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cfht_table</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">])</span>
        <span class="n">cfht_day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cfht_table</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">])</span>
        <span class="n">cfht_hr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cfht_table</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">])</span>
        <span class="n">cfht_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cfht_table</span><span class="p">[</span><span class="s1">&#39;minute&#39;</span><span class="p">])</span>
        <span class="c1"># Convert wind speed in knots to m/s. 1 knot = 1852 m/hr</span>
        <span class="n">cfht_wdspd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cfht_table</span><span class="p">[</span><span class="s1">&#39;wdspd&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span> <span class="mf">1852.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">60.0</span> <span class="o">*</span> <span class="mf">60.0</span><span class="p">)</span> <span class="p">)</span>
        <span class="c1"># Wind direction in degrees</span>
        <span class="n">cfht_wddir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cfht_table</span><span class="p">[</span><span class="s1">&#39;wddir&#39;</span><span class="p">])</span>

        <span class="c1"># Convert CFHT data from HST to UT</span>
        <span class="n">cfht_hr</span> <span class="o">+=</span> <span class="mi">10</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cfht_hr</span> <span class="o">&gt;=</span> <span class="mi">24</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cfht_day</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">cfht_hr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">24</span>

        <span class="c1"># Extract CFHT data that corresponds to date of observation</span>
        <span class="c1"># (CFHT data file contains data for the entire year, which we</span>
        <span class="c1"># (do not need for one night of observation)</span>
        <span class="n">cfht_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">cfht_mon</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">))</span> <span class="o">&amp;</span> 
                           <span class="p">(</span><span class="n">cfht_day</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">day</span><span class="p">))</span> <span class="p">)</span>
        <span class="n">cfht_yr</span> <span class="o">=</span> <span class="n">cfht_yr</span><span class="p">[</span><span class="n">cfht_i</span><span class="p">]</span>
        <span class="n">cfht_mon</span> <span class="o">=</span> <span class="n">cfht_mon</span><span class="p">[</span><span class="n">cfht_i</span><span class="p">]</span>
        <span class="n">cfht_day</span> <span class="o">=</span> <span class="n">cfht_day</span><span class="p">[</span><span class="n">cfht_i</span><span class="p">]</span>
        <span class="n">cfht_hr</span> <span class="o">=</span> <span class="n">cfht_hr</span><span class="p">[</span><span class="n">cfht_i</span><span class="p">]</span>
        <span class="n">cfht_min</span> <span class="o">=</span> <span class="n">cfht_min</span><span class="p">[</span><span class="n">cfht_i</span><span class="p">]</span>
        <span class="n">cfht_wdspd</span> <span class="o">=</span> <span class="n">cfht_wdspd</span><span class="p">[</span><span class="n">cfht_i</span><span class="p">]</span>
        <span class="n">cfht_wddir</span> <span class="o">=</span> <span class="n">cfht_wddir</span><span class="p">[</span><span class="n">cfht_i</span><span class="p">]</span>

        <span class="c1"># Create array with CFHT time data in hours</span>
        <span class="n">cfht_time_in_hrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cfht_hr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">cfht_min</span><span class="p">,</span> <span class="mf">60.0</span><span class="p">))</span>

        <span class="c1"># Load in PHTO data and parse into individual arrays</span>
        <span class="n">rows_to_skip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> 
                                        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">145</span><span class="p">,</span> <span class="mi">207</span><span class="p">))</span> <span class="p">)</span>
        <span class="n">phto_table</span> <span class="o">=</span> <span class="n">read_csv</span><span class="p">(</span><span class="n">saveto</span> <span class="o">+</span> <span class="n">phto</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span>\
                             <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="n">skiprows</span><span class="o">=</span><span class="n">rows_to_skip</span><span class="p">,</span> 
                             <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hght&#39;</span><span class="p">,</span> <span class="s1">&#39;drct&#39;</span><span class="p">,</span> <span class="s1">&#39;sknt&#39;</span><span class="p">])</span>
        <span class="n">phto_hghts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">phto_table</span><span class="p">[</span><span class="s1">&#39;hght&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">phto_wddir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phto_table</span><span class="p">[</span><span class="s1">&#39;drct&#39;</span><span class="p">])</span>
        <span class="n">phto_wdspd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phto_table</span><span class="p">[</span><span class="s1">&#39;sknt&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span> <span class="mf">1852.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">60.0</span> <span class="o">*</span> <span class="mf">60.0</span><span class="p">)</span> <span class="p">)</span>

        <span class="c1"># PHTO heights are relative to sea level, but MAOS atm.ht is</span>
        <span class="c1"># height above telescope, so we need to subtract the height</span>
        <span class="c1"># of Keck (4145 m) from phto_hghts to convert to height</span>
        <span class="c1"># above telescope</span>
        <span class="n">phto_hghts</span> <span class="o">-=</span> <span class="mf">4145.0</span>
        <span class="c1"># Discard entries with negative heights</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">phto_hghts</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">phto_hghts</span> <span class="o">=</span> <span class="n">phto_hghts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="c1"># Find PHTO data closest to the following heights (meters); ground layer (0.0 m) calculated with CFHT data</span>
        <span class="n">heights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">500.0</span><span class="p">,</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="mf">2000.0</span><span class="p">,</span> <span class="mf">4000.0</span><span class="p">,</span> <span class="mf">8000.0</span><span class="p">,</span> <span class="mf">16000.0</span><span class="p">])</span>
        <span class="n">phto_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">heights</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">heights</span><span class="p">)):</span>
            <span class="n">phto_hght_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">phto_hghts</span> <span class="o">-</span> <span class="n">heights</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>            
            <span class="n">phto_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">phto_hght_diff</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="c1"># Fetch MASS/DIMM/CFHT data closest to exposure time</span>
        <span class="n">expstart_float</span> <span class="o">=</span> <span class="n">expstart_hr</span> <span class="o">+</span> <span class="p">(</span><span class="n">expstart_min</span><span class="o">/</span><span class="mf">60.0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">expstart_sec</span><span class="o">/</span><span class="mf">3600.0</span><span class="p">)</span>
        <span class="n">expstop_float</span> <span class="o">=</span> <span class="n">expstop_hr</span> <span class="o">+</span> <span class="p">(</span><span class="n">expstop_min</span><span class="o">/</span><span class="mf">60.0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">expstop_sec</span><span class="o">/</span><span class="mf">3600.0</span><span class="p">)</span>
        <span class="n">i_dimm_start</span><span class="p">,</span> <span class="n">i_mass_start</span><span class="p">,</span> <span class="n">i_cfht_start</span> <span class="o">=</span> <span class="n">fetch_mass_dimm_cfht_loc</span><span class="p">(</span><span class="n">dimm_time_in_hrs</span><span class="p">,</span> 
                                                                            <span class="n">mass_time_in_hrs</span><span class="p">,</span> 
                                                                            <span class="n">cfht_time_in_hrs</span><span class="p">,</span>
                                                                            <span class="n">expstart_float</span><span class="p">)</span>
        <span class="n">i_dimm_stop</span><span class="p">,</span> <span class="n">i_mass_stop</span><span class="p">,</span> <span class="n">i_cfht_stop</span> <span class="o">=</span> <span class="n">fetch_mass_dimm_cfht_loc</span><span class="p">(</span><span class="n">dimm_time_in_hrs</span><span class="p">,</span>
                                                                         <span class="n">mass_time_in_hrs</span><span class="p">,</span> 
                                                                         <span class="n">cfht_time_in_hrs</span><span class="p">,</span>
                                                                         <span class="n">expstop_float</span><span class="p">)</span>
        <span class="n">closest_dimm_start</span> <span class="o">=</span> <span class="n">dimm_seeing</span><span class="p">[</span><span class="n">i_dimm_start</span><span class="p">]</span>
        <span class="n">closest_dimm_stop</span> <span class="o">=</span> <span class="n">dimm_seeing</span><span class="p">[</span><span class="n">i_dimm_stop</span><span class="p">]</span>
        <span class="n">avg_dimm</span> <span class="o">=</span> <span class="p">(</span><span class="n">closest_dimm_start</span> <span class="o">+</span> <span class="n">closest_dimm_stop</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">dimm_date_start</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimm_yr</span><span class="p">[</span><span class="n">i_dimm_start</span><span class="p">])</span> \
                          <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimm_mon</span><span class="p">[</span><span class="n">i_dimm_start</span><span class="p">])</span> \
                          <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimm_day</span><span class="p">[</span><span class="n">i_dimm_start</span><span class="p">])</span> \
                          <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimm_hr</span><span class="p">[</span><span class="n">i_dimm_start</span><span class="p">])</span> \
                          <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimm_min</span><span class="p">[</span><span class="n">i_dimm_start</span><span class="p">])</span> \
                          <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimm_sec</span><span class="p">[</span><span class="n">i_dimm_start</span><span class="p">])</span>
        <span class="n">dimm_date_stop</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimm_yr</span><span class="p">[</span><span class="n">i_dimm_stop</span><span class="p">])</span> \
                         <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimm_mon</span><span class="p">[</span><span class="n">i_dimm_stop</span><span class="p">])</span> \
                         <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimm_day</span><span class="p">[</span><span class="n">i_dimm_stop</span><span class="p">])</span> \
                         <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimm_hr</span><span class="p">[</span><span class="n">i_dimm_stop</span><span class="p">])</span> \
                         <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimm_min</span><span class="p">[</span><span class="n">i_dimm_stop</span><span class="p">])</span> \
                         <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimm_sec</span><span class="p">[</span><span class="n">i_dimm_stop</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Closest DIMM data to beginning of exposure:</span><span class="se">\t</span><span class="si">%0.4f</span><span class="se">\t</span><span class="s2">at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> 
              <span class="p">(</span><span class="n">closest_dimm_start</span><span class="p">,</span> <span class="n">dimm_date_start</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Closest DIMM data to end of exposure:</span><span class="se">\t\t</span><span class="si">%0.4f</span><span class="se">\t</span><span class="s2">at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> 
              <span class="p">(</span><span class="n">closest_dimm_stop</span><span class="p">,</span> <span class="n">dimm_date_stop</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Average DIMM over exposure:</span><span class="se">\t\t\t</span><span class="si">%0.4f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">avg_dimm</span><span class="p">)</span>
        
        <span class="c1"># Some output formatting</span>
        <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">mass_profile_start</span> <span class="o">=</span> <span class="p">[</span><span class="n">mass_cn2dh05</span><span class="p">[</span><span class="n">i_mass_start</span><span class="p">],</span> <span class="n">mass_cn2dh1</span><span class="p">[</span><span class="n">i_mass_start</span><span class="p">],</span>
                              <span class="n">mass_cn2dh2</span><span class="p">[</span><span class="n">i_mass_start</span><span class="p">],</span> <span class="n">mass_cn2dh4</span><span class="p">[</span><span class="n">i_mass_start</span><span class="p">],</span>
                              <span class="n">mass_cn2dh8</span><span class="p">[</span><span class="n">i_mass_start</span><span class="p">],</span> <span class="n">mass_cn2dh16</span><span class="p">[</span><span class="n">i_mass_start</span><span class="p">]]</span>
        <span class="n">mass_profile_stop</span> <span class="o">=</span> <span class="p">[</span><span class="n">mass_cn2dh05</span><span class="p">[</span><span class="n">i_mass_stop</span><span class="p">],</span> <span class="n">mass_cn2dh1</span><span class="p">[</span><span class="n">i_mass_stop</span><span class="p">],</span>
                             <span class="n">mass_cn2dh2</span><span class="p">[</span><span class="n">i_mass_stop</span><span class="p">],</span> <span class="n">mass_cn2dh4</span><span class="p">[</span><span class="n">i_mass_stop</span><span class="p">],</span>
                             <span class="n">mass_cn2dh8</span><span class="p">[</span><span class="n">i_mass_stop</span><span class="p">],</span> <span class="n">mass_cn2dh16</span><span class="p">[</span><span class="n">i_mass_stop</span><span class="p">]]</span>
        <span class="n">mass_date_start</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mass_yr</span><span class="p">[</span><span class="n">i_mass_start</span><span class="p">])</span> \
                          <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mass_mon</span><span class="p">[</span><span class="n">i_mass_start</span><span class="p">])</span> \
                          <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mass_day</span><span class="p">[</span><span class="n">i_mass_start</span><span class="p">])</span> \
                          <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mass_hr</span><span class="p">[</span><span class="n">i_mass_start</span><span class="p">])</span> \
                          <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mass_min</span><span class="p">[</span><span class="n">i_mass_start</span><span class="p">])</span> \
                          <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mass_sec</span><span class="p">[</span><span class="n">i_mass_start</span><span class="p">])</span>
        <span class="n">mass_date_stop</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mass_yr</span><span class="p">[</span><span class="n">i_mass_stop</span><span class="p">])</span> \
                         <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mass_mon</span><span class="p">[</span><span class="n">i_mass_stop</span><span class="p">])</span> \
                         <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mass_day</span><span class="p">[</span><span class="n">i_mass_stop</span><span class="p">])</span> \
                         <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mass_hr</span><span class="p">[</span><span class="n">i_mass_stop</span><span class="p">])</span> \
                         <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mass_min</span><span class="p">[</span><span class="n">i_mass_stop</span><span class="p">])</span> \
                         <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mass_sec</span><span class="p">[</span><span class="n">i_mass_stop</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Closest MASS data to beginning of exposure: &quot;</span><span class="p">,</span> 
              <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass_profile_start</span><span class="p">),</span> <span class="s2">&quot;at &quot;</span><span class="p">,</span> <span class="n">mass_date_start</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Closest MASS data to end of exposure:</span><span class="se">\t</span><span class="s2">    &quot;</span><span class="p">,</span> 
              <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass_profile_stop</span><span class="p">),</span> <span class="s2">&quot;at &quot;</span><span class="p">,</span> <span class="n">mass_date_stop</span><span class="p">)</span>

        <span class="n">cfht_date_start</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cfht_yr</span><span class="p">[</span><span class="n">i_cfht_start</span><span class="p">])</span> \
                          <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cfht_mon</span><span class="p">[</span><span class="n">i_cfht_start</span><span class="p">])</span> \
                          <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cfht_day</span><span class="p">[</span><span class="n">i_cfht_start</span><span class="p">])</span> \
                          <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cfht_hr</span><span class="p">[</span><span class="n">i_cfht_start</span><span class="p">])</span> \
                          <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cfht_min</span><span class="p">[</span><span class="n">i_cfht_start</span><span class="p">])</span>
        <span class="n">cfht_date_stop</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cfht_yr</span><span class="p">[</span><span class="n">i_cfht_stop</span><span class="p">])</span> \
                         <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cfht_mon</span><span class="p">[</span><span class="n">i_cfht_stop</span><span class="p">])</span> \
                         <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cfht_day</span><span class="p">[</span><span class="n">i_cfht_stop</span><span class="p">])</span> \
                         <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cfht_hr</span><span class="p">[</span><span class="n">i_cfht_stop</span><span class="p">])</span> \
                         <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cfht_min</span><span class="p">[</span><span class="n">i_cfht_stop</span><span class="p">])</span>
        
        <span class="c1"># Estimate turbulence for beginning and end of exposure</span>
        <span class="n">r0_start</span><span class="p">,</span> <span class="n">start_turb</span> <span class="o">=</span> <span class="n">estimate_turbulence</span><span class="p">(</span><span class="n">closest_dimm_start</span><span class="p">,</span> 
                                                   <span class="n">mass_profile_start</span><span class="p">,</span>
                                                   <span class="n">date_for_massdimm</span><span class="p">,</span> 
                                                   <span class="n">plot</span><span class="p">)</span>
        <span class="n">r0_end</span><span class="p">,</span> <span class="n">end_turb</span> <span class="o">=</span> <span class="n">estimate_turbulence</span><span class="p">(</span><span class="n">closest_dimm_stop</span><span class="p">,</span> 
                                               <span class="n">mass_profile_stop</span><span class="p">,</span>
                                               <span class="n">date_for_massdimm</span><span class="p">,</span>
                                               <span class="n">plot</span><span class="p">)</span>
        <span class="c1"># Average these two turbulence profiles together (we average due to potential</span>
        <span class="c1"># noise involved in the MASS/DIMM measurements)</span>
        <span class="n">avg_turb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">start_turb</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end_turb</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">avg_r0</span> <span class="o">=</span> <span class="p">(</span><span class="n">r0_start</span> <span class="o">+</span> <span class="n">r0_end</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*** Full turbulence profile:</span><span class="se">\t\t</span><span class="s2">    &quot;</span><span class="p">,</span> <span class="n">avg_turb</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** Fried parameter (m):</span><span class="se">\t\t\t</span><span class="si">%0.6f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">avg_r0</span><span class="p">)</span>

        <span class="c1"># Average CFHT data across exposure to calculate ground layer wind speed</span>
        <span class="c1"># and direction</span>
        <span class="n">cfht_wdspd_start</span> <span class="o">=</span> <span class="n">cfht_wdspd</span><span class="p">[</span><span class="n">i_cfht_start</span><span class="p">]</span>
        <span class="n">cfht_wddir_start</span> <span class="o">=</span> <span class="n">cfht_wddir</span><span class="p">[</span><span class="n">i_cfht_start</span><span class="p">]</span>
        <span class="n">cfht_wdspd_stop</span> <span class="o">=</span> <span class="n">cfht_wdspd</span><span class="p">[</span><span class="n">i_cfht_stop</span><span class="p">]</span>
        <span class="n">cfht_wddir_stop</span> <span class="o">=</span> <span class="n">cfht_wddir</span><span class="p">[</span><span class="n">i_cfht_stop</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Closest CFHT data to beginning of exposure: </span><span class="si">%0.4f</span><span class="s2"> (m/s) | </span><span class="si">%0.4f</span><span class="s2"> (deg) at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> 
              <span class="p">(</span><span class="n">cfht_wdspd_start</span><span class="p">,</span> <span class="n">cfht_wddir_start</span><span class="p">,</span> <span class="n">cfht_date_start</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Closest CFHT data to end of exposure:</span><span class="se">\t</span><span class="s2">    </span><span class="si">%0.4f</span><span class="s2"> (m/s) | </span><span class="si">%0.4f</span><span class="s2"> (deg) at </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">cfht_wdspd_stop</span><span class="p">,</span> <span class="n">cfht_wddir_stop</span><span class="p">,</span> <span class="n">cfht_date_stop</span><span class="p">))</span>

        <span class="n">avg_grnd_wdspd</span> <span class="o">=</span> <span class="p">(</span> <span class="n">cfht_wdspd_start</span> <span class="o">+</span> <span class="n">cfht_wdspd_stop</span> <span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">avg_grnd_wddir</span> <span class="o">=</span> <span class="p">(</span> <span class="n">cfht_wddir_start</span> <span class="o">+</span> <span class="n">cfht_wddir_stop</span> <span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">free_atm_wdspd</span> <span class="o">=</span> <span class="n">phto_wdspd</span><span class="p">[</span><span class="n">phto_indices</span><span class="p">]</span>
        <span class="n">free_atm_wddir</span> <span class="o">=</span> <span class="n">phto_wddir</span><span class="p">[</span><span class="n">phto_indices</span><span class="p">]</span>
        <span class="n">wind_spd_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">avg_grnd_wdspd</span><span class="p">]),</span> 
                                                     <span class="n">free_atm_wdspd</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">wind_dir_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">avg_grnd_wddir</span><span class="p">]),</span> 
                                                     <span class="n">free_atm_wddir</span><span class="p">)</span> <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Free atm wind speed/direction profiles taken at these heights:&quot;</span><span class="p">,</span> 
              <span class="n">phto_hghts</span><span class="p">[</span><span class="n">phto_indices</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** Full wind speed profile (m/s): &quot;</span><span class="p">,</span> <span class="n">wind_spd_profile</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** Full wind direction profile (deg): &quot;</span><span class="p">,</span> <span class="n">wind_dir_profile</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">avg_r0</span><span class="p">,</span> <span class="n">avg_turb</span><span class="p">,</span> <span class="n">wind_spd_profile</span><span class="p">,</span> <span class="n">wind_dir_profile</span></div>


<div class="viewcode-block" id="run_maos_sims">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.run_maos_sims.html#paarti.utils.maos_utils.run_maos_sims">[docs]</a>
<span class="k">def</span> <span class="nf">run_maos_sims</span><span class="p">(</span><span class="n">sim_dirs</span><span class="p">,</span> <span class="n">top_configs</span><span class="p">,</span> <span class="n">metrics_files</span><span class="p">,</span> 
                  <span class="n">maos_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">aper</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to run multiple MAOS simulations in terminal with</span>
<span class="sd">    various options.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    sim_dirs      : array, dtype=string</span>
<span class="sd">        Directory(ies) containing configuration files for each</span>
<span class="sd">        simulation to be run.</span>

<span class="sd">        For example, the output folder for running the base Keck</span>
<span class="sd">        single-conjugate laser-guide-star AO case is </span>
<span class="sd">        &lt;path to base&gt;/base/top_configs[i]</span>

<span class="sd">    top_configs   : array, dtype=string</span>
<span class="sd">        The name(s) of the top-level configuration file(s) </span>
<span class="sd">        for simulation(s). These will provide the names for the </span>
<span class="sd">        simulation output directory folder(s). NOTE: These are the</span>
<span class="sd">        names of the files ONLY, not the paths. By convention,</span>
<span class="sd">        these files are located in the simulation directories, so</span>
<span class="sd">        the user should not specify their full path.</span>

<span class="sd">    metrics_files : array, dtype=string</span>
<span class="sd">        Path/name of text file to write calc_strehl results to. Note: MAOS</span>
<span class="sd">        will write and store the simulation outputs in out_dirs. calc_strehl</span>
<span class="sd">        will find and read in the simulation outputs to compute various</span>
<span class="sd">        metrics (Strehl, FWHM, RMS WFE, etc.), and will then write these </span>
<span class="sd">        metrics to the metrics_file</span>

<span class="sd">    maos_plot     : boolean, default=True</span>
<span class="sd">        MAOS output plot option, turned on or off</span>

<span class="sd">    aper          : float, default=0.3</span>
<span class="sd">        Aperture size for calc_strehl function used in calculating</span>
<span class="sd">        simulation results.</span>
<span class="sd">        </span>
<span class="sd">    Outputs:</span>
<span class="sd">    ------------</span>
<span class="sd">    None, simulation runs in terminal and results are written to output</span>
<span class="sd">    directory</span>

<span class="sd">    By Brooke DiGia</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Change plotting options if user has turned them off</span>
    <span class="n">plotall</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">plotsetup</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">maos_plot</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">plotall</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">plotsetup</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sim_dirs</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">top_configs</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Missing configuration files. Aborting...&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_dirs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Loop to set output directories before running simulations</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sim_dirs</span><span class="p">)):</span>
            <span class="n">folder_name</span> <span class="o">=</span> <span class="n">top_configs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.conf&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sim_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;/&quot;</span><span class="p">:</span>
                <span class="n">out_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">folder_name</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">folder_name</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>

        <span class="c1"># Simulation loop</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sim_dirs</span><span class="p">)):</span>
            <span class="c1"># MAOS requires working directory to be the same as simulation</span>
            <span class="c1"># directory for a successful run, so if user is located elsewhere,</span>
            <span class="c1"># move current working directory to simulation directory and </span>
            <span class="c1"># notify user</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cwd</span> <span class="o">!=</span> <span class="n">sim_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current working directory (CWD) is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cwd</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Moving CWD to MAOS simulation directory...&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">sim_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="n">on_sky_filename</span> <span class="o">=</span> <span class="n">sim_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">6</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_psf.fits&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">on_sky_filename</span><span class="p">)</span>
            <span class="n">on_sky_path</span> <span class="o">=</span> <span class="s2">&quot;/u/bdigia/work/ao/single_psfs/good_run_psfs/&quot;</span>
            <span class="n">on_sky_file</span> <span class="o">=</span> <span class="n">on_sky_path</span> <span class="o">+</span> <span class="n">on_sky_filename</span>

            <span class="n">r0z</span><span class="p">,</span> <span class="n">turbulence</span><span class="p">,</span> <span class="n">wind_spd</span><span class="p">,</span> <span class="n">wind_drct</span> <span class="o">=</span> <span class="n">estimate_on_sky_conditions</span><span class="p">(</span><span class="n">on_sky_file</span><span class="p">,</span> <span class="n">on_sky_path</span><span class="p">)</span>

            <span class="n">maos_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;maos -o </span><span class="si">{</span><span class="n">out_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> -c </span><span class="si">{</span><span class="n">top_configs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> plot.all=</span><span class="si">{</span><span class="n">plotall</span><span class="si">}</span><span class="s2"> plot.setup=</span><span class="si">{</span><span class="n">plotsetup</span><span class="si">}</span><span class="s2"> atm.r0z=</span><span class="si">{</span><span class="n">r0z</span><span class="si">}</span><span class="s2"> atm.wt=</span><span class="si">{</span><span class="n">turbulence</span><span class="si">}</span><span class="s2"> atm.ws=</span><span class="si">{</span><span class="n">wind_spd</span><span class="si">}</span><span class="s2"> atm.wddeg=</span><span class="si">{</span><span class="n">wind_drct</span><span class="si">}</span><span class="s2"> -O&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">maos_cmd</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Simulation results will be stored in </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">out_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># os.system(maos_cmd)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">maos_cmd</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MAOS simulations interrupted. Aborting...&quot;</span><span class="p">)</span>
                <span class="k">return</span>
    
        <span class="c1"># After all simulations are run, fetch and display results</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out_dirs</span><span class="p">)):</span>
            <span class="n">calc_strehl</span><span class="p">(</span><span class="n">out_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">metrics_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">skysub</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apersize</span><span class="o">=</span><span class="n">aper</span><span class="p">)</span>
    
    <span class="k">return</span></div>


<div class="viewcode-block" id="maos_phase_screen_grid">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.maos_phase_screen_grid.html#paarti.utils.maos_utils.maos_phase_screen_grid">[docs]</a>
<span class="k">def</span> <span class="nf">maos_phase_screen_grid</span><span class="p">(</span><span class="n">r0s</span><span class="p">,</span> <span class="n">l0s</span><span class="p">,</span> <span class="n">on_sky</span><span class="p">,</span> <span class="n">thres</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to test multiple NCPA r0 and l0 parameter values, in comparison</span>
<span class="sd">    to an on-sky Strehl quantity (currently hard-coded below). The best </span>
<span class="sd">    (r0, l0) combinations are determined via the input threshold.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    ----------</span>
<span class="sd">    r0s    : array, variable length, dtype=float</span>
<span class="sd">        Array of NCPA surf r0 values for which to run MAOS base Keck simulation</span>

<span class="sd">    l0s    : array, variable length, dtype=float</span>
<span class="sd">        Array of NCPA surf l0 values for which to run MAOS base Keck simulation</span>

<span class="sd">    on_sky : float</span>
<span class="sd">        On-sky Strehl quantity for comparison</span>

<span class="sd">    thres  : float, default = 0.05</span>
<span class="sd">        Threshold for determining if a phase screen is &quot;best&quot; for output</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ----------</span>
<span class="sd">    best  : array, variable length, 8-element tuples of floats</span>
<span class="sd">        Array of best combinations of r0 and l0 and their corresponding</span>
<span class="sd">        strehls, fwhms, and rmswfes</span>

<span class="sd">    Also displays simulation results in terminal and writes output metrics to</span>
<span class="sd">    text file defined below as &quot;metrics_file&quot; via the calc_strehl function</span>

<span class="sd">    By Brooke DiGia</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">base_root</span> <span class="o">=</span> <span class="s2">&quot;/u/bdigia/work/ao/keck/maos/keck/base/&quot;</span>
    <span class="n">best</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">r0</span> <span class="ow">in</span> <span class="n">r0s</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">l0</span> <span class="ow">in</span> <span class="n">l0s</span><span class="p">:</span>
            <span class="c1"># Set MAOS command based on current r0 and l0</span>
            <span class="n">maos_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;maos -o A_keck_scao_lgs_gc_r0=</span><span class="si">{</span><span class="n">r0</span><span class="si">}</span><span class="s2">_l0=</span><span class="si">{</span><span class="n">l0</span><span class="si">}</span><span class="s2"> -c A_keck_scao_lgs_gc.conf plot.all=1 plot.setup=1 surf = [&quot;Keck_ncpa_rmswfe130nm.fits&quot;, &quot;&#39;r0=</span><span class="si">{</span><span class="n">r0</span><span class="si">}</span><span class="s2">;l0=</span><span class="si">{</span><span class="n">l0</span><span class="si">}</span><span class="s2">;ht=40000;slope=-2; SURFWFS=1; SURFEVL=1; seed=10;&#39;&quot;] -O&quot;&quot;&quot;</span>

            <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="c1"># Must be in MAOS simulation directory to run successfully</span>
            <span class="k">if</span> <span class="n">cwd</span> <span class="o">!=</span> <span class="n">base_root</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current working directory (CWD) is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cwd</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Moving CWD to MAOS simulation directory...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">base_root</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">maos_cmd</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error running MAOS: &quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
                <span class="k">return</span>

    <span class="c1"># After all simulations are run, fetch and display results</span>
    <span class="k">for</span> <span class="n">r0</span> <span class="ow">in</span> <span class="n">r0s</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">l0</span> <span class="ow">in</span> <span class="n">l0s</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;A_keck_scao_lgs_gc_r0=</span><span class="si">{</span><span class="n">r0</span><span class="si">}</span><span class="s2">_l0=</span><span class="si">{</span><span class="n">l0</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">metrics_file</span> <span class="o">=</span> <span class="n">base_root</span> <span class="o">+</span> <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;_sim_results.txt&quot;</span>
            <span class="n">sim_dir</span> <span class="o">=</span> <span class="n">base_root</span> <span class="o">+</span> <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"> **** r0 = </span><span class="si">{</span><span class="n">r0</span><span class="si">}</span><span class="s2"> | l0 = </span><span class="si">{</span><span class="n">l0</span><span class="si">}</span><span class="s2"> ****&quot;</span><span class="p">)</span>
            <span class="n">strehl_array</span><span class="p">,</span> <span class="n">fwhm_array</span><span class="p">,</span> <span class="n">rmswfe_array</span> <span class="o">=</span> <span class="n">calc_strehl</span><span class="p">(</span><span class="n">sim_dir</span><span class="p">,</span> 
                                                                 <span class="n">metrics_file</span><span class="p">,</span> 
                                                                 <span class="n">skysub</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                                                 <span class="n">apersize</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="c1"># Currently comparing to on_sky only at 2.12 microns</span>
            <span class="n">delta_strehl</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">on_sky</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">strehl_array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">delta_fwhm</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">on_sky</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">fwhm_array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">delta_rmswfe</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">on_sky</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">rmswfe_array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">delta_strehl</span> <span class="o">&lt;=</span> <span class="n">thres</span><span class="p">:</span>
                <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">r0</span><span class="p">,</span> <span class="n">l0</span><span class="p">,</span> <span class="n">strehl_array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">delta_strehl</span><span class="p">,</span> <span class="n">fwhm_array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">delta_fwhm</span><span class="p">,</span> <span class="n">rmswfe_array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">delta_rmswfe</span><span class="p">)</span>
                <span class="n">best</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">)</span>

    <span class="c1"># Sort resultant &#39;best&#39; tuples based on delta Strehl values</span>
    <span class="n">best</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tup</span><span class="p">:</span> <span class="n">tup</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">***** Best combinations *****&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;r0 | l0 | Strehl | Delta Strehl | FWHM (mas) | Delta FWHM (mas) | RMS WFE (nm) | Delta RMS WFE (nm)&quot;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">best</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">best</span></div>


<div class="viewcode-block" id="make_strehl_plot">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.make_strehl_plot.html#paarti.utils.maos_utils.make_strehl_plot">[docs]</a>
<span class="k">def</span> <span class="nf">make_strehl_plot</span><span class="p">(</span><span class="n">maos_txts</span><span class="p">,</span> <span class="n">saveto</span><span class="p">,</span> <span class="n">file_suffix</span><span class="o">=</span><span class="s2">&quot;.pdf&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to take an array of MAOS simulation results</span>
<span class="sd">    and plot the Strehl results at 2.12 microns versus the </span>
<span class="sd">    corresponding on-sky Strehl results (available at only</span>
<span class="sd">    2.12 microns). </span>

<span class="sd">    Inputs:</span>
<span class="sd">    ----------</span>
<span class="sd">    maos_txts   : array, variable length, dtype=string</span>
<span class="sd">        Array of MAOS simulation Strehl calculator output</span>
<span class="sd">        text files containing results to plot.</span>

<span class="sd">    saveto      : string</span>
<span class="sd">        Location to save plot images</span>

<span class="sd">    file_suffix : string, default=.pdf</span>
<span class="sd">        File type for saving plot (PDF or PNG)</span>

<span class="sd">    Outputs:</span>
<span class="sd">    ----------</span>
<span class="sd">    None, plot image (PDF or PNG) saved to desired output</span>
<span class="sd">    folder</span>

<span class="sd">    By Brooke DiGia</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;MAOS_Strehl_Plot&quot;</span>
    <span class="n">on_sky</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">maos_txts</span><span class="p">))</span>
    <span class="n">maos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">maos_txts</span><span class="p">))</span>
    <span class="n">on_sky_root</span> <span class="o">=</span> <span class="s2">&quot;/u/bdigia/work/ao/single_psfs/good_run_psfs/&quot;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">maos_txts</span><span class="p">)):</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">maos_txts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">9</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">on_sky</span> <span class="o">=</span> <span class="n">calc_strehl_on_sky</span><span class="p">([</span><span class="n">on_sky_root</span> <span class="o">+</span> <span class="n">frame</span> <span class="o">+</span> <span class="s2">&quot;_psf.fits&quot;</span><span class="p">],</span> 
                                     <span class="n">on_sky_root</span> <span class="o">+</span> <span class="n">frame</span> <span class="o">+</span> <span class="s2">&quot;_GC_Strehl.txt&quot;</span><span class="p">,</span> 
                                     <span class="n">apersize</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Read in MAOS result at 2.12 microns only</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">read_csv</span><span class="p">(</span><span class="n">maos_txts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                         <span class="n">skiprows</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;strehl&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TABLE&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;strehl&#39;</span><span class="p">])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;MAOS Strehl (calculated via PAARTI)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;On-Sky GC Strehl&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">maos</span><span class="p">,</span> <span class="n">on_sky</span><span class="p">,</span> <span class="s2">&quot;bo&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">saveto</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="n">file_suffix</span><span class="p">)</span>
    <span class="k">return</span></div>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The following *_on_sky() functons are copied from the KAI repository, linked</span>
<span class="sd">above in function headers, for use on on-sky PSF images. This is to keep the</span>
<span class="sd">KAI pipeline unchanged in its own repository.</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="calc_strehl_on_sky">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.calc_strehl_on_sky.html#paarti.utils.maos_utils.calc_strehl_on_sky">[docs]</a>
<span class="k">def</span> <span class="nf">calc_strehl_on_sky</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span> <span class="n">out_file</span><span class="p">,</span> <span class="n">apersize</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> 
                       <span class="n">instrument</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">skysub</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the Strehl, FWHM, and RMS WFE for each image in a</span>
<span class="sd">    list of files. The output is stored into the specified &lt;out_file&gt;</span>
<span class="sd">    text file. The FWHM (and Strehl) is calculated over the specified</span>
<span class="sd">    aperture size using a 2D gaussian fit. The Strehl is estimated by</span>
<span class="sd">    taking the max pixel flux / wide-aperture flux and normalizing</span>
<span class="sd">    by the same on a diffraction-limited image. Note that the diffraction</span>
<span class="sd">    limited image comes from an external file.</span>

<span class="sd">    The diffraction limited images come with the pipeline. For Keck, they are</span>
<span class="sd">    all obtained empirically using the NIRC2 camera and filters and they</span>
<span class="sd">    are sampled at 0.009952 arcsec / pixel. We will resample them as necessary.</span>
<span class="sd">    We will play fast and loose with them and use them for both NIRC2 and OSIRIS.</span>
<span class="sd">    They will be resampled as needed.</span>

<span class="sd">    Inputs</span>
<span class="sd">    ----------</span>
<span class="sd">    file_list : list or array</span>
<span class="sd">        The list of the file names.</span>

<span class="sd">    out_file : str</span>
<span class="sd">        The name of the output text file.</span>

<span class="sd">    aper_size : float (def = 0.3 arcsec)</span>
<span class="sd">        The aperture size over which to calculate the Strehl and FWHM.</span>

<span class="sd">    skysub    : boolean (def = False)</span>
<span class="sd">        Option to perform sky subtraction on input PSF</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">kai</span> <span class="kn">import</span> <span class="n">instruments</span>
    <span class="k">if</span> <span class="n">instrument</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">instruments</span><span class="o">.</span><span class="n">default_inst</span>

    <span class="c1"># Setup the output file and format.</span>
    <span class="n">_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="n">fmt_hdr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{img:&lt;30s}</span><span class="s1"> </span><span class="si">{strehl:&gt;7s}</span><span class="s1"> </span><span class="si">{rms:&gt;7s}</span><span class="s1"> </span><span class="si">{fwhm:&gt;7s}</span><span class="s1">  </span><span class="si">{mjd:&gt;10s}</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">fmt_dat</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{img:&lt;30s}</span><span class="s1"> </span><span class="si">{strehl:7.3f}</span><span class="s1"> </span><span class="si">{rms:7.1f}</span><span class="s1"> </span><span class="si">{fwhm:7.2f}</span><span class="s1">  </span><span class="si">{mjd:10.4f}</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="n">_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt_hdr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="s1">&#39;#Filename&#39;</span><span class="p">,</span> <span class="n">strehl</span><span class="o">=</span><span class="s1">&#39;Strehl&#39;</span><span class="p">,</span> <span class="n">rms</span><span class="o">=</span><span class="s1">&#39;RMSwfe&#39;</span><span class="p">,</span> 
                              <span class="n">fwhm</span><span class="o">=</span><span class="s1">&#39;FWHM&#39;</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="s1">&#39;MJD&#39;</span><span class="p">))</span>
    <span class="n">_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt_hdr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="s1">&#39;#()&#39;</span><span class="p">,</span> <span class="n">strehl</span><span class="o">=</span><span class="s1">&#39;()&#39;</span><span class="p">,</span> <span class="n">rms</span><span class="o">=</span><span class="s1">&#39;(nm)&#39;</span><span class="p">,</span> 
                              <span class="n">fwhm</span><span class="o">=</span><span class="s1">&#39;(mas)&#39;</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="s1">&#39;(UT)&#39;</span><span class="p">))</span>

    <span class="c1"># Find the root directory where the calibration files live.</span>
    <span class="n">base_path</span> <span class="o">=</span> <span class="s2">&quot;/u/bdigia/code/python/KAI/kai&quot;</span>
    <span class="n">cal_dir</span> <span class="o">=</span> <span class="n">base_path</span> <span class="o">+</span> <span class="s1">&#39;/data/diffrac_lim_img/&#39;</span> <span class="o">+</span> <span class="n">instrument</span><span class="o">.</span><span class="n">telescope</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>

    <span class="c1"># We are going to assume that everything in this list</span>
    <span class="c1"># has the same camera, filter, plate scale, etc.</span>
    <span class="n">img0</span><span class="p">,</span> <span class="n">hdr0</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">file_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">filt</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_filter_name</span><span class="p">(</span><span class="n">hdr0</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_plate_scale</span><span class="p">(</span><span class="n">hdr0</span><span class="p">)</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_central_wavelength</span><span class="p">(</span><span class="n">hdr0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Filter = </span><span class="si">%s</span><span class="s2"> | Scale (arcsec/px) = </span><span class="si">%f</span><span class="s2"> | Wavelength (microns) = </span><span class="si">%f</span><span class="s2"> &quot;</span> <span class="o">%</span> 
          <span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">))</span>

    <span class="c1"># Get the diffraction limited image for this filter.</span>
    <span class="n">dl_img_file</span> <span class="o">=</span> <span class="n">cal_dir</span> <span class="o">+</span> <span class="n">filt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
    <span class="n">dl_img</span><span class="p">,</span> <span class="n">dl_hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">dl_img_file</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Get the DL image scale and re-scale it to match the science iamge.</span>
    <span class="k">if</span> <span class="s1">&#39;Keck&#39;</span> <span class="ow">in</span> <span class="n">instrument</span><span class="o">.</span><span class="n">telescope</span><span class="p">:</span>
        <span class="n">scale_dl</span> <span class="o">=</span> <span class="mf">0.009952</span>  <span class="c1"># Hard-coded</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scale_dl</span> <span class="o">=</span> <span class="n">dl_img</span><span class="p">[</span><span class="s1">&#39;PIXSCALE&#39;</span><span class="p">]</span>
    <span class="n">rescale</span> <span class="o">=</span> <span class="n">scale_dl</span> <span class="o">/</span> <span class="n">scale</span>

    <span class="k">if</span> <span class="n">rescale</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dl_img</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">zoom</span><span class="p">(</span><span class="n">dl_img</span><span class="p">,</span> <span class="n">rescale</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Pick appropriate radii for extraction.</span>
    <span class="c1"># The diffraction limited resolution in pixels.</span>
    <span class="n">dl_res_in_pix</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">wavelength</span> <span class="o">/</span> <span class="p">(</span><span class="n">instrument</span><span class="o">.</span><span class="n">telescope_diam</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">apersize</span> <span class="o">/</span> <span class="n">scale</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">radius</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="mi">3</span>
    
    <span class="c1"># Perform some wide-aperture photometry on the diffraction-limited image.</span>
    <span class="c1"># We will normalize our Strehl by this value. We will do the same on the</span>
    <span class="c1"># data later on.</span>
    <span class="n">peak_coords_dl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dl_img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> <span class="n">dl_img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dl_img</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;/u/bdigia/work/ao/single_psfs/good_run_psfs/test_on_sky_dl_plot.pdf&quot;</span><span class="p">)</span>
    <span class="c1"># Calculate the peak flux ratio</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dl_peak_flux_ratio</span> <span class="o">=</span> <span class="n">calc_peak_flux_ratio_on_sky</span><span class="p">(</span><span class="n">dl_img</span><span class="p">,</span> <span class="n">peak_coords_dl</span><span class="p">,</span> 
                                                         <span class="n">radius</span><span class="p">,</span> <span class="n">skysub</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dl_peak_flux_ratio:&quot;</span><span class="p">,</span> <span class="n">dl_peak_flux_ratio</span><span class="p">)</span>
        <span class="c1"># For each image, get the strehl, FWHM, RMS WFE, MJD, etc. and write to an</span>
        <span class="c1"># output file.</span>
        <span class="n">strehls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)):</span>
            <span class="n">strehl</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">rmswfe</span> <span class="o">=</span> <span class="n">calc_strehl_single_on_sky</span><span class="p">(</span><span class="n">file_list</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">radius</span><span class="p">,</span> 
                                                             <span class="n">dl_peak_flux_ratio</span><span class="p">,</span> 
                                                             <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span> <span class="n">skysub</span><span class="o">=</span><span class="n">skysub</span><span class="p">)</span>
            <span class="n">strehls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">strehl</span><span class="p">)</span>
            <span class="n">mjd</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file_list</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">instrument</span><span class="o">.</span><span class="n">hdr_keys</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">])</span>
            <span class="n">dirname</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_list</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>

            <span class="n">_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt_dat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">strehl</span><span class="o">=</span><span class="n">strehl</span><span class="p">,</span> <span class="n">rms</span><span class="o">=</span><span class="n">rmswfe</span><span class="p">,</span> 
                                      <span class="n">fwhm</span><span class="o">=</span><span class="n">fwhm</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">mjd</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">fmt_dat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">strehl</span><span class="o">=</span><span class="n">strehl</span><span class="p">,</span> <span class="n">rms</span><span class="o">=</span><span class="n">rmswfe</span><span class="p">,</span> 
                                 <span class="n">fwhm</span><span class="o">=</span><span class="n">fwhm</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">mjd</span><span class="p">))</span>
        <span class="n">_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">astropy</span><span class="o">.</span><span class="n">nddata</span><span class="o">.</span><span class="n">PartialOverlapError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;astropy.nddata.PartialOverlapError, failing gracefully...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)):</span>
            <span class="n">_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt_dat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">strehl</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rms</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> 
                                      <span class="n">fwhm</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">mjd</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">fmt_dat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">strehl</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rms</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> 
                                 <span class="n">fwhm</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">mjd</span><span class="p">))</span>
        <span class="n">_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">strehls</span></div>


<div class="viewcode-block" id="calc_strehl_single_on_sky">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.calc_strehl_single_on_sky.html#paarti.utils.maos_utils.calc_strehl_single_on_sky">[docs]</a>
<span class="k">def</span> <span class="nf">calc_strehl_single_on_sky</span><span class="p">(</span><span class="n">img_file</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">dl_peak_flux_ratio</span><span class="p">,</span> 
                              <span class="n">skysub</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>


    <span class="kn">from</span> <span class="nn">kai</span> <span class="kn">import</span> <span class="n">instruments</span>
    <span class="k">if</span> <span class="n">instrument</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">instruments</span><span class="o">.</span><span class="n">default_inst</span>    
    <span class="c1"># Read in the image and header.</span>
    <span class="n">img</span><span class="p">,</span> <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">img_file</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_central_wavelength</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span> <span class="c1"># microns</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_plate_scale</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>

    <span class="c1"># Position of Strehl source</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">])</span>

    <span class="c1"># Use Strehl source coordinates in the header, if available and recorded</span>
    <span class="k">if</span> <span class="s1">&#39;XSTREHL&#39;</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;XSTREHL&#39;</span><span class="p">]),</span>
                           <span class="nb">float</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;YSTREHL&#39;</span><span class="p">])])</span>
        <span class="n">coords</span> <span class="o">-=</span> <span class="mi">1</span>     <span class="c1"># Coordinate were 1 based; but python is 0 based.</span>
    
    <span class="c1"># Calculate the FWHM using a 2D gaussian fit. We will just average the two.</span>
    <span class="c1"># To make this fit more robust, we will change our boxsize around, slowly</span>
    <span class="c1"># shrinking it until we get a reasonable value.</span>

    <span class="c1"># First estimate the DL FWHM in pixels. Use this to set the boxsize for</span>
    <span class="c1"># the FWHM estimation... note that this is NOT the aperture size specified</span>
    <span class="c1"># above which is only used for estimating the Strehl.</span>
    <span class="n">dl_res_in_pix</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">wavelength</span> <span class="o">/</span> <span class="p">(</span><span class="n">instrument</span><span class="o">.</span><span class="n">telescope_diam</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">fwhm_min</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">dl_res_in_pix</span>
    <span class="n">fwhm_max</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">fwhm_boxsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dl_res_in_pix</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">fwhm_boxsize</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">fwhm_boxsize</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">pos_delta_max</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">fwhm_min</span>
    <span class="n">box_scale</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">iters</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Steadily increase the boxsize until we get a reasonable FWHM estimate.</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">fwhm</span> <span class="o">&lt;</span> <span class="n">fwhm_min</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fwhm</span> <span class="o">&gt;</span> <span class="n">fwhm_max</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">iters</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">):</span>
        <span class="n">box_scale</span> <span class="o">+=</span> <span class="n">iters</span> <span class="o">*</span> <span class="mf">0.1</span>
        <span class="n">iters</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">g2d</span> <span class="o">=</span> <span class="n">fit_gaussian2d</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">fwhm_boxsize</span><span class="o">*</span><span class="n">box_scale</span><span class="p">,</span>
                             <span class="n">fwhm_min</span><span class="o">=</span><span class="mf">0.8</span><span class="o">*</span><span class="n">fwhm_min</span><span class="p">,</span> <span class="n">fwhm_max</span><span class="o">=</span><span class="n">fwhm_max</span><span class="p">,</span>
                             <span class="n">pos_delta_max</span><span class="o">=</span><span class="n">pos_delta_max</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="p">(</span><span class="n">g2d</span><span class="o">.</span><span class="n">x_stddev_0</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">g2d</span><span class="o">.</span><span class="n">y_stddev_0</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">fwhm</span> <span class="o">=</span> <span class="n">stddev_to_fwhm</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">img_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">iters</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span>
                  <span class="n">g2d</span><span class="o">.</span><span class="n">x_mean_0</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">g2d</span><span class="o">.</span><span class="n">y_mean_0</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">fwhm_boxsize</span><span class="o">*</span><span class="n">box_scale</span><span class="p">)</span>

        <span class="c1"># Update the coordinates if they are reasonable. </span>
        <span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">g2d</span><span class="o">.</span><span class="n">x_mean_0</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">fwhm_boxsize</span><span class="p">)</span> <span class="ow">and</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">g2d</span><span class="o">.</span><span class="n">y_mean_0</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">fwhm_boxsize</span><span class="p">)):</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">g2d</span><span class="o">.</span><span class="n">x_mean_0</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">g2d</span><span class="o">.</span><span class="n">y_mean_0</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>

    <span class="c1"># Convert to milli-arcseconds</span>
    <span class="n">fwhm</span> <span class="o">*=</span> <span class="n">scale</span> <span class="o">*</span> <span class="mf">1e3</span>

    <span class="c1"># Calculate the peak flux ratio</span>
    <span class="n">peak_flux_ratio</span> <span class="o">=</span> <span class="n">calc_peak_flux_ratio_on_sky</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">skysub</span><span class="p">)</span>

    <span class="c1"># Normalize by the same from the DL image to get the Strehl.</span>
    <span class="n">strehl</span> <span class="o">=</span> <span class="n">peak_flux_ratio</span> <span class="o">/</span> <span class="n">dl_peak_flux_ratio</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;peak flux ratio = &#39;</span><span class="p">,</span> <span class="n">peak_flux_ratio</span><span class="p">,</span> <span class="s1">&#39; dl peak flux ratio = &#39;</span><span class="p">,</span> <span class="n">dl_peak_flux_ratio</span><span class="p">)</span>

    <span class="c1"># Convert the Strehl to a RMS WFE using the Marechal approximation.</span>
    <span class="n">rms_wfe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">strehl</span><span class="p">))</span> <span class="o">*</span> <span class="n">wavelength</span> <span class="o">*</span> <span class="mf">1.0e3</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    
    <span class="c1"># Check final values and fail gracefully.</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">strehl</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">strehl</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span><span class="n">fwhm</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fwhm</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">fwhm_min</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">))):</span>
        <span class="n">strehl</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">fwhm</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">rms_wfe</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="n">fmt_dat</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{img:&lt;30s}</span><span class="s1"> </span><span class="si">{strehl:7.3f}</span><span class="s1"> </span><span class="si">{rms:7.1f}</span><span class="s1"> </span><span class="si">{fwhm:7.2f}</span><span class="s1"> </span><span class="si">{xpos:6.1f}</span><span class="s1"> </span><span class="si">{ypos:6.1f}</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">fmt_dat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">img_file</span><span class="p">,</span> <span class="n">strehl</span><span class="o">=</span><span class="n">strehl</span><span class="p">,</span> <span class="n">rms</span><span class="o">=</span><span class="n">rms_wfe</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">fwhm</span><span class="p">,</span> <span class="n">xpos</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ypos</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    
    <span class="k">return</span> <span class="n">strehl</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">rms_wfe</span></div>


<div class="viewcode-block" id="calc_peak_flux_ratio_on_sky">
<a class="viewcode-back" href="../../../api/paarti.utils.maos_utils.calc_peak_flux_ratio_on_sky.html#paarti.utils.maos_utils.calc_peak_flux_ratio_on_sky">[docs]</a>
<span class="k">def</span> <span class="nf">calc_peak_flux_ratio_on_sky</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">skysub</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    img : 2D numpy array</span>
<span class="sd">        The image on which to calculate the flux ratio of the peak to a </span>
<span class="sd">        wide-aperture.</span>

<span class="sd">    coords : list or numpy array, length = 2</span>
<span class="sd">        The x and y position of the source.</span>

<span class="sd">    radius : int</span>
<span class="sd">        The radius, in pixels, of the wide-aperture. </span>

<span class="sd">    skysub : boolean</span>
<span class="sd">        Option to perform sky subtraction.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Determine the peak flux</span>
    <span class="n">peak_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> 
                                             <span class="n">img</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">peak_flux</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">peak_coords</span><span class="p">]</span>
    
    <span class="c1"># Calculate the Strehl by first finding the peak-pixel flux / wide-aperture flux.</span>
    <span class="c1"># Then normalize by the same thing from the reference DL image. </span>
    <span class="n">aper_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">skysub</span><span class="p">:</span>
        <span class="n">sky_rad_inn</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">20</span>
        <span class="n">sky_rad_out</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">30</span>
        <span class="n">sky_aper</span> <span class="o">=</span> <span class="n">CircularAnnulus</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">sky_rad_inn</span><span class="p">,</span> <span class="n">sky_rad_out</span><span class="p">)</span>
        <span class="n">sky_aper_out</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">sky_aper</span><span class="p">)</span>
        <span class="n">sky_aper_sum</span> <span class="o">=</span> <span class="n">sky_aper_out</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">aper_sum</span> <span class="o">-=</span> <span class="n">sky_aper_sum</span>

    <span class="c1"># Calculate the peak pixel flux / wide-aperture flux</span>
    <span class="n">peak_flux_ratio</span> <span class="o">=</span> <span class="n">peak_flux</span> <span class="o">/</span> <span class="n">aper_sum</span>
    
    <span class="k">return</span> <span class="n">peak_flux_ratio</span></div>


</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2023, J.R. Lu.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.2.6. &nbsp;
    Last built 18 Nov 2023. <br/>
  </p>
</footer>
  </body>
</html>